<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Isis Studio | Editor de Card</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        @font-face {
            font-family: 'TTRunsTrialExtraBold';
            src: url('https://fonts.cdnfonts.com/s/32463/TT%20Runs%20Bold.woff') format('woff');
            font-weight: 800;
            font-style: normal;
        }

        :root {
            --bg-deep: #0a0f18;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #6366f1;
            /* WhatsApp Colors */
            --wa-bg: #0b141a;
            --wa-bubble-in: #202c33;
            --wa-text-primary: #e9edef;
            --wa-text-secondary: #8696a0;
            --wa-accent: #53bdeb;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.15) 0%, transparent 35%),
                radial-gradient(circle at 100% 100%, rgba(168, 85, 247, 0.15) 0%, transparent 35%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
        }

        .preview-container {
            position: relative;
            padding: 4px;
            border-radius: 20px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
        }

        .preview-container::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                transparent, 
                rgba(99, 102, 241, 0.8), 
                rgba(168, 85, 247, 0.8), 
                transparent 30%
            );
            animation: rotateLight 4s linear infinite;
        }

        .preview-inner {
            position: relative;
            background: var(--bg-deep);
            border-radius: 16px;
            z-index: 1;
            touch-action: none;
        }

        @keyframes rotateLight {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes progressLoad {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        .carousel-progress-bar {
            animation: progressLoad 4s linear infinite;
        }

        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        input[type=range] { -webkit-appearance: none; appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; height: 18px; width: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }

        #welcomeCanvas { border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); max-width: 100%; background: #000; display: block; }
        .nav-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .nav-btn.active { color: var(--accent); border-bottom: 2px solid var(--accent); background: rgba(99, 102, 241, 0.1); }
        .move-mode-active #welcomeCanvas { outline: 2px solid var(--accent); cursor: crosshair; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Estilos espec√≠ficos para o Preview do WhatsApp */
        .wa-bg { background-color: var(--wa-bg); background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); background-blend-mode: overlay; background-size: 400px; }
        .wa-bubble { background-color: var(--wa-bubble-in); border-radius: 0px 12px 12px 12px; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .wa-bubble::before { content: ''; position: absolute; top: 0; left: -8px; width: 0; height: 0; border: 8px solid transparent; border-top-color: var(--wa-bubble-in); border-right-color: var(--wa-bubble-in); clip-path: polygon(100% 0, 0 0, 100% 100%); }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-7xl mx-auto mb-10 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-4xl font-extrabold tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400">
                ISIS STUDIO <span class="text-sm font-light text-gray-500 ml-2 tracking-widest uppercase">v2.0 Upgrade</span>
            </h1>
        </div>
        <div class="flex gap-2">
            <button id="toggleMoveModeButton" onclick="toggleMoveMode()" 
                class="px-6 py-2 rounded-full border border-indigo-500/50 hover:bg-indigo-500/20 transition font-semibold text-sm flex items-center gap-2">
                <span id="moveIcon">üéØ</span> <span id="moveText">Modo Arrasto</span>
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-4 order-2 lg:order-1">
            <div class="glass-panel p-6 sticky top-8">
                <div class="flex overflow-x-auto gap-4 mb-8 pb-2 no-scrollbar">
                    <button onclick="switchTab('panel-background', this)" class="nav-btn active px-3 py-1 text-xs font-bold uppercase tracking-wider whitespace-nowrap">Cena</button>
                    <button onclick="switchTab('panel-text', this)" class="nav-btn px-3 py-1 text-xs font-bold uppercase tracking-wider whitespace-nowrap">Texto</button>
                    <button onclick="switchTab('panel-positions', this)" class="nav-btn px-3 py-1 text-xs font-bold uppercase tracking-wider whitespace-nowrap">Ajustes</button>
                    <button onclick="switchTab('panel-help', this)" class="nav-btn px-3 py-1 text-xs font-bold uppercase tracking-wider whitespace-nowrap">Ajuda</button>
                </div>

                <div id="panel-background" class="panel active">
                    <div class="space-y-6">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Imagem de Fundo (URL)</label>
                            <input type="text" id="bgUrlInput" placeholder="backgraund opc..." oninput="updateCanvas()" class="w-full bg-black/40 border border-white/10 rounded-lg py-2 px-3 focus:outline-none focus:border-indigo-500 transition text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Cor Fundo</label><input type="color" id="bgColorInput" value="#0b1323" oninput="updateCanvas()" class="w-full h-10 bg-transparent"></div>
                            <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">HEX Fundo</label><input type="text" id="bgColorHex" value="#0B1323" oninput="syncColor(this, 'bgColorInput')" class="w-full bg-black/40 border border-white/10 rounded-lg py-2 text-center text-sm uppercase"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Cor Box ID</label><input type="color" id="idBoxColorInput" value="#454545" oninput="updateCanvas()" class="w-full h-10 bg-transparent"></div>
                            <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">HEX Box</label><input type="text" id="idBoxColorHex" value="#454545" oninput="syncColor(this, 'idBoxColorInput')" class="w-full bg-black/40 border border-white/10 rounded-lg py-2 text-center text-sm uppercase"></div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between text-xs mb-1"><span>Raio Usu√°rio</span><span id="userRadiusValue" class="text-indigo-400">66</span></div>
                            <input type="range" id="userRadius" min="10" max="150" value="66" oninput="updateCanvas()" class="w-full">
                            
                            <div class="flex justify-between text-xs mb-1"><span>Raio Grupo</span><span id="groupRadiusValue" class="text-indigo-400">35</span></div>
                            <input type="range" id="groupRadius" min="10" max="100" value="20" oninput="updateCanvas()" class="w-full">
                        </div>
                    </div>
                </div>

                <div id="panel-text" class="panel">
                    <div class="space-y-6">
                        <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Mensagem Welcome</label><input type="text" id="welcomeTextInput" value="Bem Vindo" oninput="updateCanvas()" class="w-full bg-black/40 border border-white/10 rounded-lg py-2 px-3 text-sm"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Fonte</label><input type="range" id="welcomeFontSize" min="20" max="100" value="50" oninput="updateCanvas()" class="w-full"></div>
                            <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Cor</label><input type="color" id="welcomeColorInput" value="#ffffff" oninput="updateCanvas()" class="w-full h-8 bg-transparent"></div>
                        </div>
                        <hr class="border-white/5">
                        <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Nome do Grupo</label><input type="text" id="groupTextInput" value="my grup" oninput="updateCanvas()" class="w-full bg-black/40 border border-white/10 rounded-lg py-2 px-3 text-sm"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Fonte Grupo</label><input type="range" id="fontGroupSize" min="10" max="80" value="23" oninput="updateCanvas()" class="w-full"></div>
                            <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Cor Grupo</label><input type="color" id="ColorGrupname" value="#614e8e" oninput="updateCanvas()" class="w-full h-8 bg-transparent"></div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Cor ID Usu√°rio</label><input type="color" id="groupNameColorInput" value="#B9BF0A" oninput="updateCanvas()" class="w-full h-8 bg-transparent"></div>
                    </div>
                </div>

                <div id="panel-positions" class="panel">
                    <p class="text-xs text-gray-400 mb-4 italic">Arraste os elementos no canvas para ajustar a posi√ß√£o.</p>
                    <button onclick="switchTab('panel-summary', this)" class="w-full py-3 bg-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-500 transition shadow-lg">Finalizar e Exportar</button>
                </div>

                <div id="panel-help" class="panel">
                    <div class="text-center mb-4">
                        <h3 class="text-sm font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 tracking-widest uppercase">Central de Ajuda</h3>
                        <div class="h-0.5 w-12 mx-auto bg-indigo-500/50 mt-1 rounded-full"></div>
                    </div>

                    <div class="relative w-full aspect-[900/350] rounded-2xl overflow-hidden border border-white/10 shadow-2xl shadow-indigo-900/20 group mb-6">
                        <div class="absolute top-0 left-0 w-full h-1 bg-white/10 z-20">
                            <div class="carousel-progress-bar h-full bg-indigo-500"></div>
                        </div>
                        <div id="carousel-track" class="flex h-full transition-transform duration-700 ease-[cubic-bezier(0.25,1,0.5,1)]">
                            <div class="min-w-full h-full relative">
                                <img src="https://i.ibb.co/NgvM5L3P/ggmaz.png" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-gradient-to-t from-[#0a0f18] via-transparent to-transparent"></div>
                                <div class="absolute bottom-0 inset-x-0 p-4">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-indigo-600 text-white mb-1 inline-block">01</span>
                                    <h4 class="font-bold text-white text-lg leading-tight">Personalize</h4>
                                    <p class="text-xs text-gray-400 mt-1">Cores e textos totalmente edit√°veis.</p>
                                </div>
                            </div>
                            <div class="min-w-full h-full relative">
                                <img src="https://i.ibb.co/NgvM5L3P/ggmaz.png" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-gradient-to-t from-[#0a0f18] via-transparent to-transparent"></div>
                                <div class="absolute bottom-0 inset-x-0 p-4">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-purple-600 text-white mb-1 inline-block">02</span>
                                    <h4 class="font-bold text-white text-lg leading-tight">Arraste</h4>
                                    <p class="text-xs text-gray-400 mt-1">Mova os elementos direto no preview.</p>
                                </div>
                            </div>
                            <div class="min-w-full h-full relative">
                                <img src="https://i.ibb.co/NgvM5L3P/ggmaz.png" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-gradient-to-t from-[#0a0f18] via-transparent to-transparent"></div>
                                <div class="absolute bottom-0 inset-x-0 p-4">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-cyan-600 text-white mb-1 inline-block">03</span>
                                    <h4 class="font-bold text-white text-lg leading-tight">Pronto</h4>
                                    <p class="text-xs text-gray-400 mt-1">Exporte e use no seu servidor.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="toggleWhatsAppPreview()" class="w-full mb-6 group relative flex items-center justify-between p-4 bg-gradient-to-r from-[#25D366] to-[#128C7E] rounded-xl hover:shadow-[0_0_20px_rgba(37,211,102,0.4)] transition-all duration-300 overflow-hidden border border-white/10">
                        <div class="relative z-10 flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white font-bold text-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <h4 class="text-white font-bold text-sm leading-tight">Preview WhatsApp</h4>
                                <p class="text-white/80 text-[10px] font-medium">Veja como ficar√° no App</p>
                            </div>
                        </div>
                        <div class="absolute right-4 transform group-hover:translate-x-1 transition-transform text-white/50 group-hover:text-white">‚ûù</div>
                    </button>

                    <div id="whatsapp-preview-area" class="hidden mb-6 rounded-lg overflow-hidden border border-[#2a3942] animate-in fade-in slide-in-from-top-4 duration-300">
                        <div class="wa-bg p-4 relative">
                            <div class="flex justify-center mb-4">
                                <span class="bg-[#1f2c33] text-[#8696a0] text-[10px] font-bold px-3 py-1.5 rounded-lg shadow-sm">Hoje</span>
                            </div>

                            <div class="flex flex-col items-start max-w-[95%]">
                                <div class="wa-bubble p-1 w-full max-w-sm">
                                    <div class="flex justify-between items-center px-1 pt-1 pb-1 mb-1">
                                        <div class="flex items-center gap-1">
                                            <span class="text-[#53bdeb] text-[13px] font-bold">√¨sis</span>
                                            <span class="text-[#8696a0] text-[10px] bg-[#202c33] border border-[#2a3942] px-1 rounded flex items-center gap-0.5">
                                                <svg width="8" height="8" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                                Verificando
                                            </span>
                                        </div>
                                        <span class="text-[#8696a0] text-[10px]">~Bot</span>
                                    </div>

                                    <div class="rounded-lg overflow-hidden bg-[#0b141a] mb-1.5 border border-white/5 relative">
                                        <img id="wa-preview-img" src="" class="w-full h-auto block object-cover">
                                    </div>

                                    <div class="px-2 pb-1 relative">
                                        <p class="text-[#e9edef] text-[13px] leading-relaxed font-sans">
                                            <strong></strong>Ol√° <span style="color: #21BF58;">@mely‚úã</span>seja bem vindo (a)</strong> <br><br>
                                            <strong>üìú REGRAS DO GRUPO üìú</strong><br>
                                            <em>(Leia com aten√ß√£o para manter o grupo organizado)</em><br><br>
                                             <strong>1Ô∏è‚É£ Respeito acima de tudo ü§ù</strong><br>
                                             ÔΩ•Ofensas, xingamentos, preconceito ou desrespeito n√£o ser√£o tolerados.<br>
                                             <strong>2Ô∏è‚É£ Proibido spam üö´</strong><br>
                                             ÔΩ•Nada de links repetidos, divulga√ß√£o sem permiss√£o, correntes ou flood.<br>
                                             <strong>3Ô∏è‚É£ Conte√∫do proibido ‚õî</strong><br>
                                             ÔΩ•N√£o √© permitido conte√∫do +18, viol√™ncia, golpes, fake news ou qualquer coisa ilegal.<br>
                                                <strong>4Ô∏è‚É£ Sem discuss√µes pol√≠ticas ou religiosas üõë</strong><br>
                                                ÔΩ•Para evitar conflitos, esses temas n√£o s√£o permitidos.<br><br>
                                                <em>ü•∞Lemnbrando que essa √© uma <span style="color: #fbff00;">mensagem de exemplo ‚ö†Ô∏è</span>, ent√£o vc mesmo poder√° personalizar pela pr√≥pria bio do grupo a mensagem a ser exibida.</em>
                                        </p>
                                        <div class="flex justify-end items-center gap-1 mt-1">
                                            <span class="text-[#8696a0] text-[10px]">22:39</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-5 space-y-2">
                        <div class="group flex items-center gap-3 p-3 bg-white/5 rounded-xl border border-white/5 hover:border-indigo-500/30 transition-all hover:bg-white/10 cursor-default">
                            <div class="w-8 h-8 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400 group-hover:scale-110 transition">üé®</div>
                            <div class="flex-1 text-left">
                                <h5 class="text-xs font-bold text-gray-200">Editor Live</h5>
                                <p class="text-[9px] text-gray-500">Mude e veja na hora.</p>
                            </div>
                        </div>
                        <div class="group flex items-center gap-3 p-3 bg-white/5 rounded-xl border border-white/5 hover:border-purple-500/30 transition-all hover:bg-white/10 cursor-default">
                            <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-400 group-hover:scale-110 transition">üöÄ</div>
                            <div class="flex-1 text-left">
                                <h5 class="text-xs font-bold text-gray-200">Exporta√ß√£o</h5>
                                <p class="text-[9px] text-gray-500">C√≥digo otimizado em base64.</p>
                            </div>
                        </div>
                    </div>

                    <a href="#" onclick="alert('Suporte via Discord indispon√≠vel agora.')" class="mt-6 w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl font-bold text-xs uppercase tracking-wider shadow-lg hover:translate-y-[-2px] transition-all">
                        <span>Falar com Suporte</span>
                    </a>
                </div>

                <div id="panel-summary" class="panel">
                    <div id="summary-content" class="text-[10px] font-mono bg-black/40 p-3 rounded mb-4 break-all opacity-70"></div>
                    <button onclick="copyConfigAsBase64()" class="w-full py-2 bg-purple-600 rounded-lg text-sm font-bold">Copiar Modelo</button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8 order-1 lg:order-2 flex flex-col items-center">
            <div class="w-full flex justify-between items-center mb-4 px-2">
                <span class="text-xs font-bold text-gray-500 uppercase">Live Preview</span>
                <span class="text-[10px] px-2 py-1 bg-green-500/20 text-green-400 rounded-full border border-green-500/30">900x350 px</span>
            </div>
            
            <div class="preview-container">
                <div class="preview-inner relative group">
                    <canvas id="welcomeCanvas" width="900" height="350"></canvas>
                    <div id="dragOverlay" class="absolute inset-0 pointer-events-none border-2 border-indigo-500 rounded-xl opacity-0 flex items-center justify-center transition-opacity duration-500">
                        <span class="bg-indigo-500 text-white px-4 py-1 rounded-full text-xs font-bold shadow-xl uppercase">Modo de Edi√ß√£o Ativo</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const FIXED_USER_NAME = 'Emma_#7489';
        const SNAP_THRESHOLD = 10;

        let state = {
            userX: 437, userY: 110,
            groupX: 401, groupY: 321,
            welcomeX: 450, welcomeY: 230,
            idBoxX: 450, idBoxY: 276,
            groupNameX: 476, groupNameY: 321,
            isMoveModeActive: false
        };

        const canvas = document.getElementById('welcomeCanvas');
        const ctx = canvas.getContext('2d');
        let isDragging = false, draggedElement = null;
        let imageCache = new Map();
        let activeGuides = { x: null, y: null };

        const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

        function switchTab(panelId, btn) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(panelId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function syncColor(input, targetId) {
            document.getElementById(targetId).value = input.value;
            updateCanvas();
        }

        function toggleMoveMode() {
            state.isMoveModeActive = !state.isMoveModeActive;
            const btn = document.getElementById('toggleMoveModeButton');
            const overlay = document.getElementById('dragOverlay');
            document.getElementById('moveText').innerText = state.isMoveModeActive ? "Sair do Modo Arrasto" : "Modo Arrasto";
            btn.classList.toggle('bg-indigo-600', state.isMoveModeActive);
            document.body.classList.toggle('move-mode-active', state.isMoveModeActive);
            overlay.style.opacity = state.isMoveModeActive ? "1" : "0";
            if (state.isMoveModeActive) setTimeout(() => overlay.style.opacity = "0", 3000);
            updateCanvas();
        }

        // --- NOVA FUN√á√ÉO PARA O PREVIEW DO WHATSAPP ---
        function toggleWhatsAppPreview() {
            const previewArea = document.getElementById('whatsapp-preview-area');
            const previewImg = document.getElementById('wa-preview-img');
            
            if (previewArea.classList.contains('hidden')) {
                // Captura o estado atual do canvas como imagem
                const dataUrl = canvas.toDataURL('image/png');
                previewImg.src = dataUrl;
                
                previewArea.classList.remove('hidden');
            } else {
                previewArea.classList.add('hidden');
            }
        }

        async function updateCanvas() {
            const config = {
                bgUrl: document.getElementById('bgUrlInput').value,
                bgColor: document.getElementById('bgColorInput').value,
                idBoxColor: document.getElementById('idBoxColorInput').value,
                welcomeText: document.getElementById('welcomeTextInput').value,
                welcomeFontSize: parseInt(document.getElementById('welcomeFontSize').value),
                welcomeColor: document.getElementById('welcomeColorInput').value,
                fontGroupSize: parseInt(document.getElementById('fontGroupSize').value),
                groupTextColor: document.getElementById('ColorGrupname').value, 
                userIdColor: document.getElementById('groupNameColorInput').value,
                userRadius: parseInt(document.getElementById('userRadius').value),
                groupRadius: parseInt(document.getElementById('groupRadius').value)
            };

            // Slider values update
            document.getElementById('userRadiusValue').innerText = config.userRadius;
            document.getElementById('groupRadiusValue').innerText = config.groupRadius;

            const staticGroupText = document.getElementById('groupTextInput').value;
            document.getElementById('bgColorHex').value = config.bgColor.toUpperCase();
            document.getElementById('idBoxColorHex').value = config.idBoxColor.toUpperCase();

            ctx.fillStyle = config.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const bgImg = await loadImageAsync(config.bgUrl);
            if (bgImg) drawCover(ctx, bgImg, 0, 0, canvas.width, canvas.height);

            const userImg = await loadImageAsync("https://i.ibb.co/N6nNsRYf/lua.gif");
            const groupImg = await loadImageAsync("https://i.ibb.co/PsV0zCTw/si.jpg");
            
            drawCircularImage(ctx, state.userX, state.userY, config.userRadius, userImg, '#43B581');
            drawCircularImage(ctx, state.groupX, state.groupY, config.groupRadius, groupImg, '#ED4245');
            
            ctx.font = `800 ${config.welcomeFontSize}px TTRunsTrialExtraBold, sans-serif`;
            ctx.fillStyle = config.welcomeColor;
            ctx.textAlign = 'center';
            ctx.fillText(config.welcomeText, state.welcomeX, state.welcomeY);
            
            ctx.font = `600 ${config.fontGroupSize}px Inter, sans-serif`;
            ctx.fillStyle = config.groupTextColor;
            ctx.textAlign = 'center';
            ctx.fillText(staticGroupText, state.groupNameX, state.groupNameY);

            ctx.font = '24px Inter, sans-serif';
            const metrics = ctx.measureText(FIXED_USER_NAME);
            const boxW = metrics.width + 40, boxH = 40;
            ctx.fillStyle = config.idBoxColor;
            ctx.beginPath();
            ctx.roundRect(state.idBoxX - boxW/2, state.idBoxY - boxH/2, boxW, boxH, 20); ctx.fill();
            ctx.fillStyle = config.userIdColor;
            ctx.textBaseline = 'middle';
            ctx.fillText(FIXED_USER_NAME, state.idBoxX, state.idBoxY + 2);

            if (isDragging) {
                ctx.setLineDash([5, 5]);
                ctx.strokeStyle = '#6366f1';
                if (activeGuides.x !== null) { 
                    ctx.beginPath();
                    ctx.moveTo(activeGuides.x, 0); ctx.lineTo(activeGuides.x, canvas.height); ctx.stroke();
                }
                if (activeGuides.y !== null) { 
                    ctx.beginPath();
                    ctx.moveTo(0, activeGuides.y); ctx.lineTo(canvas.width, activeGuides.y); ctx.stroke();
                }
            }
            document.getElementById('summary-content').innerText = JSON.stringify({ ...config, ...state });
            
            // Se o preview estiver aberto, atualiza ele em tempo real
            const previewArea = document.getElementById('whatsapp-preview-area');
            if (!previewArea.classList.contains('hidden')) {
                 document.getElementById('wa-preview-img').src = canvas.toDataURL('image/png');
            }
        }

        function drawCover(ctx, img, x, y, w, h) {
            const r = img.width / img.height, cr = w / h;
            let sx, sy, sw, sh;
            if (r > cr) { sw = img.height * cr; sh = img.height;
                sx = (img.width - sw) / 2; sy = 0;
            } else { sw = img.width;
                sh = img.width / cr; sx = 0; sy = (img.height - sh) / 2;
            }
            ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
        }

        function drawCircularImage(ctx, x, y, r, img, fallback) {
            ctx.save();
            ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.clip();
            if (img) { const s = Math.max(r * 2 / img.width, r * 2 / img.height);
                ctx.drawImage(img, x - (img.width * s) / 2, y - (img.height * s) / 2, img.width * s, img.height * s);
            } else { ctx.fillStyle = fallback; ctx.fill();
            }
            ctx.restore();
        }

        function loadImageAsync(url) {
            if (!url || url === '' || url === 'false') return Promise.resolve(null);
            if (imageCache.has(url)) return Promise.resolve(imageCache.get(url));
            return new Promise(res => {
                const img = new Image(); img.crossOrigin = 'Anonymous';
                img.onload = () => { imageCache.set(url, img); res(img); };
                img.onerror = () => res(null); img.src = url;
            });
        }

        function handleStart(e) {
            if(!state.isMoveModeActive) return;
            const pos = getMousePos(e);
            if(Math.hypot(pos.x - state.userX, pos.y - state.userY) < 70) draggedElement = 'user';
            else if(Math.hypot(pos.x - state.groupX, pos.y - state.groupY) < 50) draggedElement = 'group';
            else if(Math.abs(pos.y - state.welcomeY) < 30) draggedElement = 'welcome';
            else if(Math.abs(pos.y - state.groupNameY) < 25) draggedElement = 'groupName';
            else if(Math.abs(pos.y - state.idBoxY) < 30) draggedElement = 'idBox';
            if(draggedElement) isDragging = true;
        }

        function handleMove(e) {
            if(!isDragging) return;
            if(e.cancelable) e.preventDefault();
            const pos = getMousePos(e); 
            let nx = clamp(pos.x, 0, 900);
            let ny = clamp(pos.y, 0, 350);
            activeGuides = { x: null, y: null };

            const others = [
                {x: state.userX, y: state.userY, id: 'user'},
                {x: state.groupX, y: state.groupY, id: 'group'},
                {x: state.welcomeX, y: state.welcomeY, id: 'welcome'},
                {x: state.groupNameX, y: state.groupNameY, id: 'groupName'},
                {x: state.idBoxX, y: state.idBoxY, id: 'idBox'},
                {x: 450, y: 175, id: 'center'}
            ].filter(el => el.id !== draggedElement);

            others.forEach(el => {
                if (Math.abs(nx - el.x) < SNAP_THRESHOLD) { nx = el.x; activeGuides.x = el.x; }
                if (Math.abs(ny - el.y) < SNAP_THRESHOLD) { ny = el.y; activeGuides.y = el.y; }
            });

            if(draggedElement === 'user') { state.userX = nx; state.userY = ny; }
            else if(draggedElement === 'group') { state.groupX = nx; state.groupY = ny; }
            else if(draggedElement === 'welcome') { state.welcomeX = nx; state.welcomeY = ny; }
            else if(draggedElement === 'groupName') { state.groupNameX = nx; state.groupNameY = ny; }
            else if(draggedElement === 'idBox') { state.idBoxX = nx; state.idBoxY = ny; }
            updateCanvas();
        }

        function handleEnd() { isDragging = false; draggedElement = null;
            activeGuides = { x: null, y: null }; updateCanvas(); }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - rect.left) * (900 / rect.width), y: (clientY - rect.top) * (350 / rect.height) };
        }

        canvas.addEventListener('mousedown', handleStart); window.addEventListener('mousemove', handleMove); window.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('touchstart', handleStart, { passive: false });
        window.addEventListener('touchmove', handleMove, { passive: false }); window.addEventListener('touchend', handleEnd);

        function copyConfigAsBase64() {
            const dataStr = document.getElementById('summary-content').innerText;
            const b64 = btoa(unescape(encodeURIComponent(dataStr)));
            navigator.clipboard.writeText(b64); alert("Modelo Copiado! üöÄ");
        }

        function startCarousel() {
            const track = document.getElementById('carousel-track');
            if(!track) return;
            let index = 0;
            setInterval(() => {
                index = (index + 1) % 3;
                track.style.transform = `translateX(-${index * 100}%)`;
            }, 4000);
        }

        window.onload = () => {
            updateCanvas();
            startCarousel();
        };
    </script>
</body>
</html>
