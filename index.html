<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador Welcome</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* üé® Estilos da Aplica√ß√£o e Fontes */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        /* Assumindo que o arquivo 'TT Runs Trial ExtraBold.ttf' esteja na mesma pasta */
        @font-face {
            font-family: 'TTRuns';
            src: url('TT Runs Trial ExtraBold.ttf') format('truetype');
            font-weight: 900;
            font-style: normal;
            font-display: swap;
        }

        body {
            font-family: 'Inter', sans-serif;
            /* üü¢ NOVO: Fundo principal do WhatsApp Dark */
            background-color: #374151; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        @media (min-width: 768px) {
            body {
                flex-direction: row;
                align-items: flex-start;
                justify-content: center;
                gap: 2rem;
            }
        }

        /* Estilos do Canvas */
        #welcomeCanvas {
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-width: 100%;
            height: auto;
            cursor: default;
            z-index: 10;
            touch-action: none; 
        }
        /* Cursores para o Modo Mover */
        #welcomeCanvas.canvas-draggable { cursor: grab; }
        #welcomeCanvas.dragging { cursor: grabbing; }

        /* Estilos de Controles */
        .container {
            width: 100%;
            max-width: 450px;
            z-index: 20;
            /* üü¢ NOVO: Fundo dos pain√©is (Um pouco mais claro que o body) */
            background-color: #232D36;
            padding-bottom: 20px;
        }

        .input-group { margin-bottom: 10px; }
        .color-control { display: flex; align-items: center; }
        .color-input-hex { width: 80px; text-align: center; margin-left: 8px; text-transform: uppercase; }
        
        .block-select { 
            width: 100%; 
            padding: .5rem; 
            border-radius: .5rem; 
            /* üü¢ NOVO: Fundo de inputs (Mais escuro) */
            background: #101D25; 
            /* üü¢ NOVO: Cor de texto principal (Claro) */
            color: #E9EDEF; 
            /* üü¢ NOVO: Borda/Separador */
            border: 1px solid #374151; 
        }
        .panel { display: none; }
        .panel.active { display: block; }
        .summary-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            /* üü¢ NOVO: Separador */
            border-bottom: 1px dashed #374151;
        }
        .summary-item:last-child { border-bottom: none; }
    </style>
</head>
<body class="md:flex md:flex-row md:items-start md:justify-center md:gap-8">

<div class="container bg-gray-700 p-6 rounded-lg shadow-xl mb-6">
    <h1 class="text-2xl font-bold mb-4 text-white">Mensagens de <span style="color:#7289da;">Boas-vindas</span> em grupos</h1>

    <div class="mb-4">
        <label for="panelSelect" class="block text-gray-200 mb-2">Selecionar bloco de ajustes:</label>
        <select id="panelSelect" class="block-select" onchange="onPanelChange()">
            <option value="panel-background">Background üñºÔ∏è</option>
            <option value="panel-text">Texto & Cores üé®</option>
            <option value="panel-position">Posi√ß√£o & Tamanho ‚öôÔ∏è</option>
            <option value="panel-summary">Resumo dos Ajustes üìã</option>
        </select>
    </div>

    <div id="panel-background" class="panel active">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div class="input-group">
                <label for="userPicUrlInput" class="block text-gray-200 mb-1">URL,Usu√°rio=estaitcoüé®:</label>
                <input type="text" id="userPicUrlInput" value="https://i.ibb.co/yFhsWR4v/lua.gif" class="w-full p-2 rounded bg-gray-900 border border-gray-600 text-gray-200" oninput="updateCanvas()">
            </div>
            <div class="input-group">
                <label for="groupPicUrlInput" class="block text-gray-200 mb-1">URL,Grupo=estaitcoüé®:</label>
                <input type="text" id="groupPicUrlInput" value="https://i.ibb.co/CKWjkPWy/si.jpg" class="w-full p-2 rounded bg-gray-900 border border-gray-600 text-gray-200" oninput="updateCanvas()">
            </div>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="bgUrlInput" class="block text-gray-200 mb-1">URL do Plano de Fundo (Opcional):</label>
                <input type="text" id="bgUrlInput" value="false" class="w-full p-2 rounded bg-gray-900 border border-gray-600 text-gray-200" oninput="updateCanvas()">
            </div>
            <div>
                <label for="bgColorInput" class="block text-gray-200 mb-1">Cor S√≥lida de Fundo:</label>
                <div class="color-control">
                    <input type="color" id="bgColorInput" value="#0B1323" class="color-picker rounded bg-gray-900 border border-gray-600 cursor-pointer" oninput="syncColorInputs(this, 'bgColorHex'); updateCanvas()">
                    <input type="text" id="bgColorHex" value="#36393F" maxlength="7" class="color-input-hex p-1 rounded bg-gray-900 border border-gray-600 text-gray-200" oninput="syncColorInputs(this, 'bgColorInput'); updateCanvas()">
                </div>
            </div>
        </div>
    </div>

    <div id="panel-text" class="panel">
        <div class="mt-4 border-t pt-4 border-gray-700">
            <h2 class="text-xl font-bold text-purple-400 mb-4">Ajustes de Texto e Cores</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="welcomeTextInput" class="block text-gray-200 mb-1">
                        Texto de Boas-Vindas:
                        <span class="text-xs text-blue-400 ml-2">X:<span id="welcomeXValue">450</span> Y:<span id="welcomeYValue">230</span></span>
                    </label>
                    <input type="text" id="welcomeTextInput" value="Bem Vindo(a)" class="w-full p-2 rounded bg-gray-900 border border-gray-600 text-gray-200" oninput="updateCanvas()">
                </div>
                <div class="input-group">
                    <label for="welcomeColorInput" class="block text-gray-200 mb-1">Cor do Texto de Boas-Vindas:</label>
                    <div class="color-control">
                        <input type="color" id="welcomeColorInput" value="#FFFFFF" class="color-picker rounded bg-gray-900 border border-gray-600 cursor-pointer" oninput="syncColorInputs(this, 'welcomeColorHex'); updateCanvas()">
                        <input type="text" id="welcomeColorHex" value="#FFFFFF" maxlength="7" class="color-input-hex p-1 rounded bg-gray-900 border border-gray-600 text-gray-200" oninput="syncColorInputs(this, 'welcomeColorInput'); updateCanvas()">
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                <div class="input-group">
                    <label for="groupNameColorInput" class="block text-gray-200 mb-1">Cor do Nome do Grupo:</label>
                    <div class="color-control">
                        <input type="color" id="groupNameColorInput" value="#FFD900" class="color-picker rounded bg-gray-900 border border-gray-600 cursor-pointer" oninput="syncColorInputs(this, 'groupNameColorHex'); updateCanvas()">
                        <input type="text" id="groupNameColorHex" value="#FFD900" maxlength="7" class="color-input-hex p-1 rounded bg-gray-900 border border-gray-600 text-gray-200" oninput="syncColorInputs(this, 'groupNameColorInput'); updateCanvas()">
                    </div>
                </div>
                <div class="input-group">
                    <label for="idBoxColorInput" class="block text-gray-200 mb-1">
                        Cor do Box de ID:
                        <span class="text-xs text-blue-400 ml-2">X:<span id="idBoxXValue">450</span> Y:<span id="idBoxYValue">310</span></span>
                    </label>
                    <div class="color-control">
                        <input type="color" id="idBoxColorInput" value="#454545" class="color-picker rounded bg-gray-900 border border-gray-600 cursor-pointer" oninput="syncColorInputs(this, 'idBoxColorHex'); updateCanvas()">
                        <input type="text" id="idBoxColorHex" value="#000000" maxlength="7" class="color-input-hex p-1 rounded bg-gray-900 border border-gray-600 text-gray-200" oninput="syncColorInputs(this, 'idBoxColorInput'); updateCanvas()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="panel-position" class="panel">
        <div class="mt-6 border-t pt-4 border-gray-700">
            <h2 class="text-xl font-bold text-blue-400 mb-4">Ajustes de Posi√ß√£o e Tamanho (Canvas 900x350px)</h2>

            <h3 class="text-lg font-semibold text-gray-200 mb-2 mt-4">Texto de Boas-Vindas (Tamanho)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-1">
                    <label for="welcomeFontSize" class="block text-gray-400 text-xs mb-1">Tamanho da Fonte: <span id="welcomeFontSizeValue">50</span>px</label>
                    <input type="range" id="welcomeFontSize" min="20" max="100" value="50" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
            </div>
            <hr class="mt-4 border-gray-700">
            
            <h3 class="text-lg font-semibold text-gray-200 mb-2 mt-4">Foto do Usu√°rio (Maior)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="userRadius" class="block text-gray-400 text-xs mb-1">Raio (Tamanho): <span id="userRadiusValue">66</span>px</label>
                    <input type="range" id="userRadius" min="50" max="150" value="66" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
                <div>
                    <label for="userX" class="block text-gray-400 text-xs mb-1">Posi√ß√£o X: <span id="userXValue">437</span>px</label>
                    <input type="range" id="userX" min="50" max="850" value="437" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
                <div>
                    <label for="userY" class="block text-gray-400 text-xs mb-1">Posi√ß√£o Y: <span id="userYValue">110</span>px</label>
                    <input type="range" id="userY" min="50" max="300" value="110" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
            </div>

            <h3 class="text-lg font-semibold text-gray-200 mb-2 mt-6">Foto do Grupo (Menor)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="groupRadius" class="block text-gray-400 text-xs mb-1">Raio (Tamanho): <span id="groupRadiusValue">35</span>px</label>
                    <input type="range" id="groupRadius" min="20" max="100" value="35" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
                <div>
                    <label for="groupX" class="block text-gray-400 text-xs mb-1">Posi√ß√£o X: <span id="groupXValue">655</span>px</label>
                    <input type="range" id="groupX" min="20" max="880" value="655" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
                <div>
                    <label for="groupY" class="block text-gray-400 text-xs mb-1">Posi√ß√£o Y: <span id="groupYValue">300</span>px</label>
                    <input type="range" id="groupY" min="20" max="330" value="300" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
            </div>

            <p class="text-sm text-gray-500 mt-4">Dica: Use o bot√£o **"Ativar Modo Mover"** abaixo para arrastar todos os elementos diretamente no Canvas!</p>
        </div>
    </div>
    
    <div id="panel-summary" class="panel">
        <div class="mt-6 border-t pt-4 border-gray-700">
            <h2 class="text-xl font-bold text-green-400 mb-4">Resumo dos Ajustes (Canvas 900x350px)</h2>
            <div id="summary-content" class="text-sm text-gray-200 bg-gray-900 p-4 rounded-lg">
                Carregando resumo...
            </div>
            <p class="text-xs text-gray-500 mt-4">As posi√ß√µes s√£o coordenadas (X, Y) do centro de cada elemento.</p>
        </div>
        
        <div class="mt-4">
            <button id="exportButton" 
        onclick="exportConfigAsJson()" 
        class="w-full font-bold py-2 px-4 rounded-lg hover:opacity-90" 
        style="background-color:#00B09C; color: #101D25;"
    >
        Exportar Config (.json)
            </button>
        </div>
    </div>

    <div class="mt-4 flex gap-2">
        <button id="toggleMoveModeButton" onclick="toggleMoveMode()" class="w-full font-bold py-2 px-4 rounded-lg" style="background-color:#00B09C; color: #101D25;">
            Ativar Modo Mover
        </button>
        <button onclick="saveSelectedPanelToStorage()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Aba Atual</button>
    </div>
</div>

<canvas id="welcomeCanvas" width="900" height="350" class="shadow-2xl"></canvas>

<script>
    const FIXED_USER_NAME = 'Jo√£o_Victor#1234';
    const FIXED_GROUP_NAME = 'Grup lexi‚ú®';
    const USER_FALLBACK_COLOR = '#43B581';
    const GROUP_FALLBACK_COLOR = '#ED4245';
    const STORAGE_SELECTED_PANEL_KEY = 'welcome_canvas_selected_panel';

    const getWelcomeFont = () => {
        const size = document.getElementById('welcomeFontSize').value;
        return `900 ${size}px TTRuns, sans-serif`;
    };
    const DEFAULT_FONT = '28px Inter, sans-serif';

    // --- VARI√ÅVEIS DE ESTADO DE ARRASTO ---
    let isDragging = false;
    let draggedElement = null;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    let isMoveModeActive = false;
    // ----------------------------------------

    // Estado das posi√ß√µes (atualizado pelos ranges e pelo drag)
    let state = {
        userX: 437, userY: 110,
        groupX: 655, groupY: 300,
        welcomeX: 450, welcomeY: 230,
        idBoxX: 450, idBoxY: 310
    };

    const canvas = document.getElementById('welcomeCanvas');
    const ctx = canvas.getContext('2d');

    function initializeState() {
        state.userX = parseInt(document.getElementById('userX').value);
        state.userY = parseInt(document.getElementById('userY').value);
        state.groupX = parseInt(document.getElementById('groupX').value);
        state.groupY = parseInt(document.getElementById('groupY').value);
        state.welcomeX = 450; 
        state.welcomeY = 230;
        state.idBoxX = 450;
        state.idBoxY = 310;
    }

    // --- FUN√á√ïES DE ARRASTO ---
    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    function startDrag(e) {
        if (!isMoveModeActive) {
            if (e.touches) { e.preventDefault(); }
            return; 
        }

        e.preventDefault(); 
        
        const pos = getMousePos(e);
        // Garante que o raio correto seja pego para o hit test
        const bounds = getElementBounds(ctx, getCurrentConfig()); 

        if (hitTest(pos.x, pos.y, bounds.idbox)) {
            draggedElement = 'idBox';
            dragOffsetX = pos.x - state.idBoxX;
            dragOffsetY = pos.y - state.idBoxY;
        } else if (hitTest(pos.x, pos.y, bounds.welcome)) {
            draggedElement = 'welcomeText';
            dragOffsetX = pos.x - state.welcomeX;
            dragOffsetY = pos.y - state.welcomeY;
        } 
        // Corre√ß√£o de hit test para os perfis circulares
        else if (hitTestCircle(pos.x, pos.y, bounds.userAvatar)) {
            draggedElement = 'userAvatar';
            dragOffsetX = pos.x - state.userX;
            dragOffsetY = pos.y - state.userY;
        } 
        else if (hitTestCircle(pos.x, pos.y, bounds.groupAvatar)) {
            draggedElement = 'groupAvatar';
            dragOffsetX = pos.x - state.groupX;
            dragOffsetY = pos.y - state.groupY;
        } else {
            draggedElement = null;
            return;
        }

        isDragging = true;
        canvas.classList.add('dragging');
    }

    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();

        const pos = getMousePos(e);
        const newX = pos.x - dragOffsetX;
        const newY = pos.y - dragOffsetY;
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;

        switch (draggedElement) {
            case 'userAvatar':
                state.userX = Math.max(50, Math.min(canvasWidth - 50, newX));
                state.userY = Math.max(50, Math.min(canvasHeight - 50, newY));
                updateRangeFromState('userX', state.userX);
                updateRangeFromState('userY', state.userY);
                break;
            case 'groupAvatar':
                state.groupX = Math.max(20, Math.min(canvasWidth - 20, newX));
                state.groupY = Math.max(20, Math.min(canvasHeight - 20, newY));
                updateRangeFromState('groupX', state.groupX);
                updateRangeFromState('groupY', state.groupY);
                break;
            case 'welcomeText':
                state.welcomeX = Math.max(0, Math.min(canvasWidth, newX));
                state.welcomeY = Math.max(0, Math.min(canvasHeight, newY));
                break;
            case 'idBox':
                state.idBoxX = Math.max(0, Math.min(canvasWidth, newX));
                state.idBoxY = Math.max(0, Math.min(canvasHeight, newY));
                break;
        }

        updateCanvas();
    }

    function endDrag(e) {
        if (isDragging) {
            isDragging = false;
            draggedElement = null;
            canvas.classList.remove('dragging');
            updateCanvas(); 
        }
    }
    
    // üü¢ NOVO: Cores do Bot√£o ajustadas para o tema WhatsApp Dark
    function toggleMoveMode() {
        isMoveModeActive = !isMoveModeActive;
        const button = document.getElementById('toggleMoveModeButton');
        
        if (isMoveModeActive) {
            button.textContent = 'Desativar Modo Mover (Arrasto Habilitado)';
            // Verde Destaque
            button.style.backgroundColor = '#00B09C'; 
            button.style.color = '#101D25';
            canvas.classList.add('canvas-draggable');
            canvas.style.cursor = 'grab'; 
        } else {
            button.textContent = 'Ativar Modo Mover';
            // Cinza Secund√°rio/Padr√£o
            button.style.backgroundColor = '#374151'; 
            button.style.color = '#E9EDEF';
            canvas.classList.remove('canvas-draggable');
            canvas.style.cursor = 'default'; 
        }
    }

    // Event Listeners para Desktop e Mobile
    canvas.addEventListener('mousedown', startDrag);
    window.addEventListener('mousemove', drag);
    window.addEventListener('mouseup', endDrag);
    canvas.addEventListener('touchstart', startDrag, { passive: false });
    window.addEventListener('touchmove', drag, { passive: false });
    window.addEventListener('touchend', endDrag);
    // --- FIM DAS FUN√á√ïES DE ARRASTO ---

    // ... (O restante das fun√ß√µes de desenho e l√≥gica permanece o mesmo, incluindo drawCircularImage) ...

    function getElementBounds(ctx, config) {
        const WELCOME_TEXT = document.getElementById('welcomeTextInput').value;
        const ID_TEXT = FIXED_USER_NAME;

        // Passa o raio correto do input para o hit test
        const userAvatarBounds = { x: state.userX, y: state.userY, radius: config.userRadius };
        const groupAvatarBounds = { x: state.groupX, y: state.groupY, radius: config.groupRadius };

        const fontSize = document.getElementById('welcomeFontSize').value;
        ctx.font = getWelcomeFont();
        const welcomeMetrics = ctx.measureText(WELCOME_TEXT);
        const welcomeWidth = welcomeMetrics.width;
        const welcomeHeight = parseInt(fontSize) * 1.1; 
        const welcomeBounds = {
            x: state.welcomeX - welcomeWidth / 2, 
            y: state.welcomeY - welcomeHeight,
            width: welcomeWidth,
            height: welcomeHeight 
        };

        ctx.font = DEFAULT_FONT;
        const idMetrics = ctx.measureText(ID_TEXT);
        const boxPaddingX = 20;
        const boxPaddingY = 10;
        const boxWidth = idMetrics.width + boxPaddingX * 2;
        const boxHeight = 28 + boxPaddingY * 2;
        const idBoxBounds = {
            x: state.idBoxX - boxWidth / 2,
            y: state.idBoxY - boxHeight / 2,
            width: boxWidth,
            height: boxHeight
        };

        return { welcome: welcomeBounds, idbox: idBoxBounds, userAvatar: userAvatarBounds, groupAvatar: groupAvatarBounds };
    }

    function hitTest(x, y, bounds) {
        return x >= bounds.x && x <= bounds.x + bounds.width &&
               y >= bounds.y && y <= bounds.y + bounds.height;
    }

    // üåü CORRE√á√ÉO FINAL: F√≥rmula de dist√¢ncia para o hit test circular
    function hitTestCircle(x, y, circleBounds) {
        const dx = x - circleBounds.x;
        const dy = y - circleBounds.y;
        return (dx * dx + dy * dy) <= (circleBounds.radius * circleBounds.radius);
    }
    
    // ... (O restante das fun√ß√µes como drawWelcomeCanvas, updateCanvas, etc., que n√£o foram alteradas) ...
    // Fun√ß√µes auxiliares (loadImageAsync, drawCircularImage, syncColorInputs, drawWelcomeCanvas, 
    // getCurrentConfig, updateCanvas, updateSummaryPanel, onPanelChange, loadSelectedPanel, 
    // saveSelectedPanelToStorage, updateRangeFromState, exportConfigAsJson)
    // s√£o omitidas aqui por brevidade, mas devem estar COMPLETAS no arquivo final.
    
    
    // Fun√ß√£o drawCircularImage: Mantenha a vers√£o anterior que desenha a imagem no Canvas

    const loadImageAsync = (url) => {
        return new Promise((resolve) => {
            if (!url || url.trim() === '' || url.trim().toLowerCase() === 'false') return resolve(null);
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => resolve(img);
            img.onerror = () => { console.error(`[INFO] Falha ao carregar imagem: ${url}`); resolve(null); };
            img.src = url;
        });
    };

    const drawCircularImage = (ctx, x, y, radius, image, fallbackColor) => {
        ctx.save();
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2, true);
        ctx.fillStyle = fallbackColor;
        ctx.fill();
        ctx.closePath();
        ctx.restore();

        if (image) {
            ctx.save();
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2, true);
            ctx.closePath();
            ctx.clip();

            const imgWidth = image.width;
            const imgHeight = image.height;
            const targetSize = radius * 2;
            let sx, sy, sWidth, sHeight;
            const imgRatio = imgWidth / imgHeight;
            const targetRatio = 1;

            if (imgRatio > targetRatio) {
                sHeight = imgHeight;
                sWidth = imgHeight * targetRatio;
                sx = (imgWidth - sWidth) / 2;
                sy = 0;
            } else {
                sWidth = imgWidth;
                sHeight = imgWidth / targetRatio;
                sx = 0;
                sy = (imgHeight - sHeight) / 2;
            }

            const dx = x - radius;
            const dy = y - radius;
            const dWidth = targetSize;
            const dHeight = targetSize;

            ctx.drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);
            ctx.restore();
        }
    };

    async function drawWelcomeCanvas(config) {
        const userPicUrl = document.getElementById('userPicUrlInput').value;
        const groupPicUrl = document.getElementById('groupPicUrlInput').value;

        const { bgUrl, bgColor, userRadius, groupRadius } = config;

        const userX = state.userX, userY = state.userY, groupX = state.groupX, groupY = state.groupY,
              welcomeX = state.welcomeX, welcomeY = state.welcomeY, idBoxX = state.idBoxX, idBoxY = state.idBoxY;

        const WELCOME_TEXT = document.getElementById('welcomeTextInput').value;
        const WELCOME_COLOR = document.getElementById('welcomeColorInput').value;
        const GROUP_NAME_COLOR = document.getElementById('groupNameColorInput').value;
        const ID_BOX_COLOR_BASE = document.getElementById('idBoxColorInput').value;
        const ID_BOX_COLOR = ID_BOX_COLOR_BASE + "E6"; // 90% opacidade

        const WELCOME_FONT = getWelcomeFont();

        const canvasWidth = canvas.width; const canvasHeight = canvas.height;

        try { await document.fonts.load(`900 100px TTRuns`); } catch (err) { /* Falha silenciosa */ }

        const [bgImage, userPicData, groupPicData] = await Promise.all([
            loadImageAsync(bgUrl), loadImageAsync(userPicUrl), loadImageAsync(groupPicUrl)
        ]);

        // 1. Fundo
        if (bgImage) {
            const imgWidth = bgImage.width, imgHeight = bgImage.height;
            const canvasRatio = canvasWidth / canvasHeight, imgRatio = imgWidth / imgHeight;
            let drawW, drawH, offsetX, offsetY;
            if (imgRatio > canvasRatio) {
                drawH = canvasHeight;
                drawW = imgWidth * (canvasHeight / imgHeight);
                offsetX = (canvasWidth - drawW) / 2; offsetY = 0;
            } else {
                drawW = canvasWidth;
                drawH = imgHeight * (canvasWidth / imgWidth);
                offsetX = 0; offsetY = (canvasHeight - drawH) / 2;
            }
            ctx.drawImage(bgImage, offsetX, offsetY, drawW, drawH);
        } else {
            ctx.fillStyle = bgColor; ctx.fillRect(0,0,canvasWidth,canvasHeight);
        }

        // Desenho de detalhes abstratos
        ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
        ctx.beginPath();
        ctx.arc(canvasWidth * 0.1, canvasHeight * 0.9, 100, 0, Math.PI * 2);
        ctx.arc(canvasWidth * 0.9, canvasHeight * 0.1, 70, 0, Math.PI * 2);
        ctx.fill();

        // 2. Fotos de Perfil
        drawCircularImage(ctx, userX, userY, userRadius, userPicData, USER_FALLBACK_COLOR);
        drawCircularImage(ctx, groupX, groupY, groupRadius, groupPicData, GROUP_FALLBACK_COLOR);

        // 3. Nome do Grupo (Fixo, n√£o arrast√°vel)
        const X_GROUP_NAME = groupX + groupRadius + 15;
        const Y_GROUP_NAME = groupY + 10;
        ctx.font = 'bold 30px Inter, sans-serif';
        ctx.textAlign = 'left';
        ctx.fillStyle = GROUP_NAME_COLOR;
        ctx.fillText(FIXED_GROUP_NAME, X_GROUP_NAME, Y_GROUP_NAME);

        // 4. Texto de Boas-Vindas (Arrast√°vel)
        ctx.font = WELCOME_FONT;
        ctx.textAlign = 'center';
        ctx.fillStyle = WELCOME_COLOR;
        ctx.fillText(WELCOME_TEXT, welcomeX, welcomeY);

        // 5. Box de ID (Arrast√°vel)
        const ID_TEXT = FIXED_USER_NAME;
        ctx.font = DEFAULT_FONT;
        const textMetrics = ctx.measureText(ID_TEXT);
        const boxPaddingX = 20, boxPaddingY = 10;
        const boxWidth = textMetrics.width + boxPaddingX * 2;
        const boxHeight = 28 + boxPaddingY * 2;
        const boxX = idBoxX - boxWidth / 2, boxY = idBoxY - boxHeight / 2;
        const borderRadius = 8;

        // Desenha o box arredondado
        ctx.fillStyle = ID_BOX_COLOR;
        ctx.beginPath();
        ctx.moveTo(boxX + borderRadius, boxY);
        ctx.lineTo(boxX + boxWidth - borderRadius, boxY);
        ctx.arcTo(boxX + boxWidth, boxY, boxX + boxWidth, boxY + borderRadius, borderRadius);
        ctx.lineTo(boxX + boxWidth, boxY + boxHeight - borderRadius);
        ctx.arcTo(boxX + boxWidth, boxY + boxHeight, boxX + boxWidth - borderRadius, boxY + boxHeight, borderRadius);
        ctx.lineTo(boxX + borderRadius, boxY + boxHeight);
        ctx.arcTo(boxX, boxY + boxHeight, boxX, boxY + boxHeight - borderRadius, borderRadius);
        ctx.lineTo(boxX, boxY + borderRadius);
        ctx.arcTo(boxX, boxY, boxX + borderRadius, boxY, borderRadius);
        ctx.fill();

        // Escreve o texto dentro do box
        const textBaselineY = idBoxY + (28 / 2) - 2;
        ctx.fillStyle = '#FFFFFF';
        ctx.textAlign = 'center';
        ctx.font = DEFAULT_FONT;
        ctx.fillText(ID_TEXT, idBoxX, textBaselineY);
    }
    
    function getCurrentConfig() {
        return {
            bgUrl: document.getElementById('bgUrlInput').value,
            bgColor: document.getElementById('bgColorInput').value,
            welcomeText: document.getElementById('welcomeTextInput').value,
            welcomeColor: document.getElementById('welcomeColorInput').value,
            groupNameColor: document.getElementById('groupNameColorInput').value,
            idBoxColor: document.getElementById('idBoxColorInput').value,
            userRadius: parseInt(document.getElementById('userRadius').value),
            groupRadius: parseInt(document.getElementById('groupRadius').value),
            welcomeFontSize: parseInt(document.getElementById('welcomeFontSize').value),
            userX: Math.round(state.userX),
            userY: Math.round(state.userY),
            groupX: Math.round(state.groupX),
            groupY: Math.round(state.groupY),
            welcomeX: Math.round(state.welcomeX),
            welcomeY: Math.round(state.welcomeY),
            idBoxX: Math.round(state.idBoxX),
            idBoxY: Math.round(state.idBoxY)
        };
    }

    function syncColorInputs(sourceInput, targetId) {
        const targetInput = document.getElementById(targetId);
        let value = sourceInput.value.toUpperCase();

        if (targetId.includes('Hex')) {
            if (!value.startsWith('#')) { value = '#' + value; }
            targetInput.value = value;
        } else {
            targetInput.value = value;
        }
    }


    function updateCanvas() {
        if (!isDragging) {
            state.userX = parseInt(document.getElementById('userX').value);
            state.userY = parseInt(document.getElementById('userY').value);
            state.groupX = parseInt(document.getElementById('groupX').value);
            state.groupY = parseInt(document.getElementById('groupY').value);
        }

        syncColorInputs(document.getElementById('bgColorInput'), 'bgColorHex');
        syncColorInputs(document.getElementById('welcomeColorInput'), 'welcomeColorHex');
        syncColorInputs(document.getElementById('groupNameColorInput'), 'groupNameColorHex');
        syncColorInputs(document.getElementById('idBoxColorInput'), 'idBoxColorHex');

        document.getElementById('userRadiusValue').textContent = document.getElementById('userRadius').value;
        document.getElementById('userXValue').textContent = Math.round(state.userX);
        document.getElementById('userYValue').textContent = Math.round(state.userY);
        document.getElementById('groupRadiusValue').textContent = document.getElementById('groupRadius').value;
        document.getElementById('groupXValue').textContent = Math.round(state.groupX);
        document.getElementById('groupYValue').textContent = Math.round(state.groupY);
        document.getElementById('welcomeXValue').textContent = Math.round(state.welcomeX);
        document.getElementById('welcomeYValue').textContent = Math.round(state.welcomeY);
        document.getElementById('idBoxXValue').textContent = Math.round(state.idBoxX);
        document.getElementById('idBoxYValue').textContent = Math.round(state.idBoxY);
        document.getElementById('welcomeFontSizeValue').textContent = document.getElementById('welcomeFontSize').value;
        
        const activePanelId = document.getElementById('panelSelect').value;
        if (activePanelId === 'panel-summary') {
            updateSummaryPanel();
        }

        drawWelcomeCanvas(getCurrentConfig());
    }

    function updateSummaryPanel() {
        const config = getCurrentConfig();
        const summaryDiv = document.getElementById('summary-content');
        
        let html = '';

        const summaryData = [
            { label: 'Cor de Fundo', value: config.bgColor, isColor: true },
            { label: 'URL de Fundo', value: config.bgUrl, isURL: true },
            { label: '--- Fotos ---', value: '' },
            { label: 'Foto do Usu√°rio (URL)', value: document.getElementById('userPicUrlInput').value, isURL: true },
            { label: 'Foto do Usu√°rio (Raio)', value: `${config.userRadius}px` },
            { label: 'Foto do Usu√°rio (Posi√ß√£o)', value: `(${config.userX}, ${config.userY})` },
            { label: 'Foto do Grupo (URL)', value: document.getElementById('groupPicUrlInput').value, isURL: true },
            { label: 'Foto do Grupo (Raio)', value: `${config.groupRadius}px` },
            { label: 'Foto do Grupo (Posi√ß√£o)', value: `(${config.groupX}, ${config.groupY})` },
            { label: '--- Texto ---', value: '' },
            { label: 'Texto de Boas-Vindas', value: config.welcomeText },
            { label: 'Cor do Texto B-V', value: config.welcomeColor, isColor: true },
            { label: 'Tam. do Texto B-V', value: `${config.welcomeFontSize}px` },
            { label: 'Pos. do Texto B-V', value: `(${config.welcomeX}, ${config.welcomeY})` },
            { label: 'Cor do Nome do Grupo', value: config.groupNameColor, isColor: true },
            { label: 'Cor do Box de ID', value: config.idBoxColor, isColor: true },
            { label: 'Posi√ß√£o do Box de ID', value: `(${config.idBoxX}, ${config.idBoxY})` }
        ];

        summaryData.forEach(item => {
            if (item.label.startsWith('---')) {
                html += `<div class="text-center font-bold text-lg mt-3 mb-1 text-yellow-300">${item.label.replace(/^-+\s*/, '').replace(/\s*-+$/, '')}</div>`;
            } else {
                let valueDisplay;
                if (item.isColor) {
                    valueDisplay = `<span style="background-color:${item.value}; border: 1px solid #4B5563;" class="inline-block w-4 h-4 rounded-full mr-2"></span>${item.value}`;
                } else if (item.isURL) {
                    valueDisplay = item.value.length > 50 ? item.value.substring(0, 47) + '...' : item.value;
                } else {
                    valueDisplay = item.value;
                }
                
                html += `
                    <div class="summary-item">
                        <span class="text-gray-400">${item.label}:</span>
                        <span class="text-white font-medium break-all text-right">${valueDisplay}</span>
                    </div>
                `;
            }
        });

        summaryDiv.innerHTML = html;
    }

    function onPanelChange() {
        const selectedId = document.getElementById('panelSelect').value;
        document.querySelectorAll('.panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.getElementById(selectedId).classList.add('active');
        
        if (selectedId === 'panel-summary') {
            updateSummaryPanel();
        }

        localStorage.setItem(STORAGE_SELECTED_PANEL_KEY, selectedId);
    }
    
    function loadSelectedPanel() {
        const lastPanelId = localStorage.getItem(STORAGE_SELECTED_PANEL_KEY);
        if (lastPanelId && document.getElementById(lastPanelId)) {
            document.getElementById('panelSelect').value = lastPanelId;
            onPanelChange();
        } else {
            document.getElementById('panel-background').classList.add('active');
            document.getElementById('panelSelect').value = 'panel-background';
        }
    }

    function saveSelectedPanelToStorage() {
        const currentPanelId = document.getElementById('panelSelect').value;
        localStorage.setItem(STORAGE_SELECTED_PANEL_KEY, currentPanelId);
        alert(`Aba '${document.querySelector(`#panelSelect option[value='${currentPanelId}']`).textContent.trim()}' salva como prefer√™ncia inicial!`);
    }

    function updateRangeFromState(elementId, value) {
        const range = document.getElementById(elementId);
        if (range) range.value = Math.round(value);
    }

    function exportConfigAsJson() {
        const config = getCurrentConfig();
        const jsonString = JSON.stringify(config, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'welcome_card_config.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    window.onload = () => {
        initializeState();
        loadSelectedPanel();
        updateCanvas();
        
        isMoveModeActive = true; 
        toggleMoveMode(); 
    };
</script>
</body>
</html>