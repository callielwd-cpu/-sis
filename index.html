<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Isis Studio | Editor de Card</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        @font-face {
            font-family: 'TTRunsTrialExtraBold';
            src: url('https://fonts.cdnfonts.com/s/32463/TT%20Runs%20Bold.woff') format('woff');
            font-weight: 800;
            font-style: normal;
        }

        :root {
            --bg-deep: #0a0f18;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #6366f1;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.15) 0%, transparent 35%),
                radial-gradient(circle at 100% 100%, rgba(168, 85, 247, 0.15) 0%, transparent 35%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
        }

        .preview-container {
            position: relative;
            padding: 4px;
            border-radius: 20px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
        }

        .preview-container::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                transparent, 
                rgba(99, 102, 241, 0.8), 
                rgba(168, 85, 247, 0.8), 
                transparent 30%
            );
            animation: rotateLight 4s linear infinite;
        }

        .preview-inner {
            position: relative;
            background: var(--bg-deep);
            border-radius: 16px;
            z-index: 1;
            touch-action: none; /* Impede scroll ao arrastar no canvas */
        }

        @keyframes rotateLight {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        input[type=range] { -webkit-appearance: none; appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; height: 18px; width: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }

        #welcomeCanvas { border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); max-width: 100%; background: #000; display: block; }
        .nav-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .nav-btn.active { color: var(--accent); border-bottom: 2px solid var(--accent); background: rgba(99, 102, 241, 0.1); }
        .move-mode-active #welcomeCanvas { outline: 2px solid var(--accent); cursor: crosshair; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-7xl mx-auto mb-10 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-4xl font-extrabold tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400">
                ISIS STUDIO <span class="text-sm font-light text-gray-500 ml-2 tracking-widest uppercase">v2.0 Upgrade</span>
            </h1>
        </div>
        <div class="flex gap-2">
            <button id="toggleMoveModeButton" onclick="toggleMoveMode()" 
                class="px-6 py-2 rounded-full border border-indigo-500/50 hover:bg-indigo-500/20 transition font-semibold text-sm flex items-center gap-2">
                <span id="moveIcon">ðŸŽ¯</span> <span id="moveText">Modo Arrasto</span>
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-4 order-2 lg:order-1">
            <div class="glass-panel p-6 sticky top-8">
                <div class="flex overflow-x-auto gap-4 mb-8 pb-2 no-scrollbar">
                    <button onclick="switchTab('panel-background', this)" class="nav-btn active px-3 py-1 text-xs font-bold uppercase tracking-wider whitespace-nowrap">Cena</button>
                    <button onclick="switchTab('panel-text', this)" class="nav-btn px-3 py-1 text-xs font-bold uppercase tracking-wider whitespace-nowrap">Texto</button>
                    <button onclick="switchTab('panel-positions', this)" class="nav-btn px-3 py-1 text-xs font-bold uppercase tracking-wider whitespace-nowrap">Ajustes</button>
                    <button onclick="switchTab('panel-help', this)" class="nav-btn px-3 py-1 text-xs font-bold uppercase tracking-wider whitespace-nowrap">Ajuda</button>
                </div>

                <div id="panel-background" class="panel active">
                    <div class="space-y-6">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Imagem de Fundo (URL)</label>
                            <input type="text" id="bgUrlInput" value="false" oninput="updateCanvas()" class="w-full bg-black/40 border border-white/10 rounded-lg py-2 px-3 focus:outline-none focus:border-indigo-500 transition text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Cor Fundo</label><input type="color" id="bgColorInput" value="#0b1323" oninput="updateCanvas()" class="w-full h-10 bg-transparent border-none"></div>
                            <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">HEX Fundo</label><input type="text" id="bgColorHex" value="#0B1323" oninput="syncColor(this, 'bgColorInput')" class="w-full bg-black/40 border border-white/10 rounded-lg py-2 px-2 text-center text-sm uppercase"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Cor Box ID</label><input type="color" id="idBoxColorInput" value="#454545" oninput="updateCanvas()" class="w-full h-10 bg-transparent"></div>
                            <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">HEX Box</label><input type="text" id="idBoxColorHex" value="#454545" oninput="syncColor(this, 'idBoxColorInput')" class="w-full bg-black/40 border border-white/10 rounded-lg py-2 px-2 text-center text-sm uppercase"></div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between text-xs mb-1"><span>Raio UsuÃ¡rio</span><span id="userRadiusValue" class="text-indigo-400">66</span></div>
                            <input type="range" id="userRadius" min="10" max="150" value="66" oninput="updateCanvas()" class="w-full">
                            <div class="flex justify-between text-xs mb-1"><span>Raio Grupo</span><span id="groupRadiusValue" class="text-indigo-400">35</span></div>
                            <input type="range" id="groupRadius" min="10" max="100" value="35" oninput="updateCanvas()" class="w-full">
                        </div>
                    </div>
                </div>

                <div id="panel-text" class="panel">
                    <div class="space-y-6">
                        <div><label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Mensagem Principal</label><input type="text" id="welcomeTextInput" value="Bem Vindo(a)" oninput="updateCanvas()" class="w-full bg-black/40 border border-white/10 rounded-lg py-2 px-3"></div>
                        <div class="space-y-1">
                            <div class="flex justify-between text-xs mb-1"><span>Tamanho da Fonte</span><span id="welcomeFontSizeValue" class="text-indigo-400">50</span></div>
                            <input type="range" id="welcomeFontSize" min="20" max="100" value="50" oninput="updateCanvas()" class="w-full">
                        </div>
                        <!-- Reintroduzindo os inputs de cor que faltavam -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Cor Texto</label>
                                <input type="color" id="welcomeColorInput" value="#ffffff" oninput="updateCanvas()" class="w-full h-10 bg-transparent cursor-pointer">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Cor Grupo</label>
                                <input type="color" id="groupNameColorInput" value="#ffd900" oninput="updateCanvas()" class="w-full h-10 bg-transparent cursor-pointer">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel-positions" class="panel">
                    <p class="text-xs text-gray-400 mb-4 italic">Arraste os elementos no canvas.</p>
                    <div class="p-3 bg-black/20 rounded-lg border border-white/5 mb-4">
                        <div class="grid grid-cols-2 gap-y-2 text-[10px]">
                            <span>UsuÃ¡rio X/Y: <span id="userXValue" class="text-white">437</span> / <span id="userYValue" class="text-white">110</span></span>
                            <span>Welcome X/Y: <span id="welcomeXValue" class="text-white">450</span> / <span id="welcomeYValue" class="text-white">230</span></span>
                        </div>
                    </div>
                    <button onclick="switchTab('panel-summary', this)" class="w-full py-3 bg-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-500 transition shadow-lg">Finalizar e Exportar</button>
                </div>

                <div id="panel-help" class="panel text-center">
                    <img id="carousel-img" src="https://i.ibb.co/pBN6NM9h/Isis2.png" class="w-32 h-32 mx-auto mb-4 object-cover rounded-full border-2 border-indigo-500 p-1">
                    <p id="carousel-text" class="text-xs italic text-gray-400">"Sua criatividade Ã© o limite! ðŸ’•"</p>
                </div>

                <div id="panel-summary" class="panel">
                    <div id="summary-content" class="text-[10px] font-mono bg-black/40 p-3 rounded mb-4 break-all opacity-70"></div>
                    <button onclick="copyConfigAsBase64()" class="w-full py-2 bg-purple-600 rounded-lg text-sm font-bold">Copiar Modelo</button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8 order-1 lg:order-2 flex flex-col items-center">
            <div class="w-full flex justify-between items-center mb-4 px-2">
                <span class="text-xs font-bold text-gray-500 uppercase">Live Preview</span>
                <span class="text-[10px] px-2 py-1 bg-green-500/20 text-green-400 rounded-full border border-green-500/30">900x350 px</span>
            </div>
            
            <div class="preview-container">
                <div class="preview-inner relative group">
                    <canvas id="welcomeCanvas" width="900" height="350"></canvas>
                    <div id="dragOverlay" class="absolute inset-0 pointer-events-none border-2 border-indigo-500 rounded-xl opacity-0 flex items-center justify-center transition-opacity duration-500">
                        <span class="bg-indigo-500 text-white px-4 py-1 rounded-full text-xs font-bold shadow-xl">MODO ARRASTO ATIVO</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const FIXED_USER_NAME = 'Sarah_Jones#7489';
        const CANVAS_CENTER_X = 450, CANVAS_CENTER_Y = 175;

        let state = {
            userX: 437, userY: 110,
            groupX: 655, groupY: 300,
            welcomeX: 450, welcomeY: 230,
            idBoxX: 450, idBoxY: 310,
            isMoveModeActive: false
        };

        const canvas = document.getElementById('welcomeCanvas');
        const ctx = canvas.getContext('2d');
        let isDragging = false, draggedElement = null;
        let imageCache = new Map();
        let activeGuides = { x: null, y: null };

        function switchTab(panelId, btn) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(panelId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function syncColor(input, targetId) {
            document.getElementById(targetId).value = input.value;
            updateCanvas();
        }

        function toggleMoveMode() {
            state.isMoveModeActive = !state.isMoveModeActive;
            const btn = document.getElementById('toggleMoveModeButton');
            const overlay = document.getElementById('dragOverlay');
            document.getElementById('moveText').innerText = state.isMoveModeActive ? "Sair do Modo Arrasto" : "Modo Arrasto";
            btn.classList.toggle('bg-indigo-600', state.isMoveModeActive);
            document.body.classList.toggle('move-mode-active', state.isMoveModeActive);
            overlay.style.opacity = state.isMoveModeActive ? "1" : "0";
            if (state.isMoveModeActive) setTimeout(() => overlay.style.opacity = "0", 3000);
            updateCanvas();
        }

        async function updateCanvas() {
            // Verifica se todos os elementos existem antes de tentar ler valores
            const elWelcomeColor = document.getElementById('welcomeColorInput');
            const elGroupColor = document.getElementById('groupNameColorInput');
            
            if (!elWelcomeColor || !elGroupColor) return; // SeguranÃ§a extra

            const config = {
                bgUrl: document.getElementById('bgUrlInput').value,
                bgColor: document.getElementById('bgColorInput').value,
                idBoxColor: document.getElementById('idBoxColorInput').value,
                welcomeText: document.getElementById('welcomeTextInput').value,
                welcomeFontSize: parseInt(document.getElementById('welcomeFontSize').value),
                welcomeColor: elWelcomeColor.value,
                groupNameColor: elGroupColor.value,
                userRadius: parseInt(document.getElementById('userRadius').value),
                groupRadius: parseInt(document.getElementById('groupRadius').value)
            };

            document.getElementById('bgColorHex').value = config.bgColor.toUpperCase();
            document.getElementById('idBoxColorHex').value = config.idBoxColor.toUpperCase();

            ctx.fillStyle = config.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const bgImg = await loadImageAsync(config.bgUrl);
            if (bgImg) drawCover(ctx, bgImg, 0, 0, canvas.width, canvas.height);

            const userImg = await loadImageAsync("https://i.ibb.co/N6nNsRYf/lua.gif");
            const groupImg = await loadImageAsync("https://i.ibb.co/PsV0zCTw/si.jpg");
            
            drawCircularImage(ctx, state.userX, state.userY, config.userRadius, userImg, '#43B581');
            drawCircularImage(ctx, state.groupX, state.groupY, config.groupRadius, groupImg, '#ED4245');

            ctx.font = `800 ${config.welcomeFontSize}px TTRunsTrialExtraBold, sans-serif`;
            ctx.fillStyle = config.welcomeColor;
            ctx.textAlign = 'center';
            ctx.fillText(config.welcomeText, state.welcomeX, state.welcomeY);

            ctx.font = '24px Inter, sans-serif';
            const metrics = ctx.measureText(FIXED_USER_NAME);
            const boxW = metrics.width + 40, boxH = 40;
            ctx.fillStyle = config.idBoxColor;
            ctx.beginPath(); ctx.roundRect(state.idBoxX - boxW/2, state.idBoxY - boxH/2, boxW, boxH, 20); ctx.fill();
            ctx.fillStyle = config.groupNameColor;
            ctx.textBaseline = 'middle';
            ctx.fillText(FIXED_USER_NAME, state.idBoxX, state.idBoxY + 2);

            if (isDragging) {
                ctx.setLineDash([5, 5]); ctx.strokeStyle = '#6366f1';
                if (activeGuides.x !== null) { ctx.beginPath(); ctx.moveTo(activeGuides.x, 0); ctx.lineTo(activeGuides.x, canvas.height); ctx.stroke(); }
                if (activeGuides.y !== null) { ctx.beginPath(); ctx.moveTo(0, activeGuides.y); ctx.lineTo(canvas.width, activeGuides.y); ctx.stroke(); }
            }

            document.getElementById('userRadiusValue').innerText = config.userRadius;
            document.getElementById('groupRadiusValue').innerText = config.groupRadius;
            document.getElementById('welcomeFontSizeValue').innerText = config.welcomeFontSize;
            document.getElementById('userXValue').innerText = Math.round(state.userX);
            document.getElementById('userYValue').innerText = Math.round(state.userY);
            document.getElementById('welcomeXValue').innerText = Math.round(state.welcomeX);
            document.getElementById('welcomeYValue').innerText = Math.round(state.welcomeY);
            
            document.getElementById('summary-content').innerText = JSON.stringify({
                ...config, ...state
            });
        }

        function drawCover(ctx, img, x, y, w, h) {
            const r = img.width / img.height, cr = w / h;
            let sx, sy, sw, sh;
            if (r > cr) { sw = img.height * cr; sh = img.height; sx = (img.width - sw) / 2; sy = 0; }
            else { sw = img.width; sh = img.width / cr; sx = 0; sy = (img.height - sh) / 2; }
            ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
        }

        function drawCircularImage(ctx, x, y, r, img, fallback) {
            ctx.save();
            ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.clip();
            if (img) {
                const s = Math.max(r * 2 / img.width, r * 2 / img.height);
                ctx.drawImage(img, x - (img.width * s) / 2, y - (img.height * s) / 2, img.width * s, img.height * s);
            } else { ctx.fillStyle = fallback; ctx.fill(); }
            ctx.restore();
            ctx.strokeStyle = 'rgba(255,255,255,0.2)'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.stroke();
        }

        function loadImageAsync(url) {
            if (!url || url === 'false') return Promise.resolve(null);
            if (imageCache.has(url)) return Promise.resolve(imageCache.get(url));
            return new Promise(res => {
                const img = new Image(); img.crossOrigin = 'Anonymous';
                img.onload = () => { imageCache.set(url, img); res(img); };
                img.onerror = () => res(null);
                img.src = url;
            });
        }

        function handleStart(e) {
            if(!state.isMoveModeActive) return;
            const pos = getMousePos(e);
            if(Math.hypot(pos.x - state.userX, pos.y - state.userY) < 70) draggedElement = 'user';
            else if(Math.hypot(pos.x - state.groupX, pos.y - state.groupY) < 50) draggedElement = 'group';
            else if(Math.abs(pos.y - state.welcomeY) < 40) draggedElement = 'welcome';
            else if(Math.abs(pos.y - state.idBoxY) < 30) draggedElement = 'idBox';
            if(draggedElement) isDragging = true;
        }

        function handleMove(e) {
            if(!isDragging) return;
            if(e.cancelable) e.preventDefault();
            const pos = getMousePos(e);
            let nx = pos.x, ny = pos.y;
            activeGuides = { x: null, y: null };

            if(Math.abs(nx - CANVAS_CENTER_X) < 10) { nx = CANVAS_CENTER_X; activeGuides.x = CANVAS_CENTER_X; }
            if(Math.abs(ny - CANVAS_CENTER_Y) < 10) { ny = CANVAS_CENTER_Y; activeGuides.y = CANVAS_CENTER_Y; }

            if(draggedElement === 'user') { state.userX = nx; state.userY = ny; }
            else if(draggedElement === 'group') { state.groupX = nx; state.groupY = ny; }
            else if(draggedElement === 'welcome') { state.welcomeX = nx; state.welcomeY = ny; }
            else if(draggedElement === 'idBox') { state.idBoxX = nx; state.idBoxY = ny; }
            updateCanvas();
        }

        function handleEnd() { isDragging = false; draggedElement = null; activeGuides = { x: null, y: null }; updateCanvas(); }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - rect.left) * (900 / rect.width), y: (clientY - rect.top) * (350 / rect.height) };
        }

        // Eventos unificados (Mouse + Touch)
        canvas.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);

        canvas.addEventListener('touchstart', handleStart, { passive: false });
        window.addEventListener('touchmove', handleMove, { passive: false });
        window.addEventListener('touchend', handleEnd);

        function copyConfigAsBase64() {
            const data = JSON.parse(document.getElementById('summary-content').innerText);
            const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
            navigator.clipboard.writeText(b64);
            alert("Modelo Copiado! ðŸš€");
        }

        window.onload = () => {
            updateCanvas();
            const imgs = ["https://i.ibb.co/pBN6NM9h/Isis2.png", "https://i.ibb.co/Gf4fBpqc/Isis.png", "https://i.ibb.co/JjzFfXx9/Isis1.png"];
            let i = 0; setInterval(() => { i = (i + 1) % imgs.length; document.getElementById('carousel-img').src = imgs[i]; }, 4000);
        };
    </script>
</body>
</html>