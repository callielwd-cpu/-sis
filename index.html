<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas de Boas-Vindas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        @font-face {
            font-family: 'TTRuns';
            src: url('TT Runs Trial ExtraBold.ttf') format('truetype');
            font-weight: 900;
            font-style: normal;
            font-display: swap;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #1F2937;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        @media (min-width: 768px) {
            body {
                flex-direction: row;
                align-items: flex-start;
                justify-content: center;
                gap: 2rem;
            }
        }

        .canvas-moved {
            position: absolute !important;
            transform: none !important;
            z-index: 50 !important;
        }

        #welcomeCanvas {
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-width: 100%;
            height: auto;
            cursor: default;
            z-index: 10;
            touch-action: none; /* evita scroll indesejado em touch enquanto interage */
        }
        #welcomeCanvas.draggable { cursor: move; }
        #welcomeCanvas.canvas-draggable { cursor: grab; }
        #welcomeCanvas.dragging { cursor: grabbing; }

        .container {
            width: 100%;
            max-width: 450px;
            z-index: 20;
            background-color: #1F2937;
            padding-bottom: 20px;
        }

        .input-group { margin-bottom: 10px; }
        .color-control { display: flex; align-items: center; }
        .color-input-hex { width: 80px; text-align: center; margin-left: 8px; text-transform: uppercase; }
        .color-picker { width: 100%; height: 40px; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #5865F2;
            cursor: pointer;
            border-radius: 50%;
            margin-top: -8px;
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #5865F2;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"] { height: 4px; background: #4F545C; }

        /* pequenos ajustes para o select/menu */
        .block-select { width: 100%; padding: .5rem; border-radius: .5rem; background: #111827; color: #fff; border: 1px solid #374151; }
        .panel { display: none; }
        .panel.active { display: block; }
        .summary-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px dashed #374151;
        }
        .summary-item:last-child { border-bottom: none; }
    </style>
</head>
<body class="md:flex md:flex-row md:items-start md:justify-center md:gap-8">

<div class="container bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
    <h1 class="text-2xl font-bold text-white mb-4">Gerador de Canvas de Boas-Vindas</h1>

    <div class="mb-4">
        <label for="panelSelect" class="block text-gray-300 mb-2">Selecionar bloco de ajustes:</label>
        <select id="panelSelect" class="block-select" onchange="onPanelChange()">
            <option value="panel-background">Background üñºÔ∏è</option>
            <option value="panel-text">Texto & Cores üé®</option>
            <option value="panel-position">Posi√ß√£o & Tamanho ‚öôÔ∏è</option>
            <option value="panel-summary">Resumo dos Ajustes üìã</option> </select>
    </div>

    <div id="panel-background" class="panel active">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div class="input-group">
                <label for="userPicUrlInput" class="block text-gray-300 mb-1">URL da Foto do Usu√°rio:</label>
                <input type="text" id="userPicUrlInput" value="https://i.ibb.co/yFhsWR4v/lua.gif" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white" oninput="updateCanvas()">
            </div>
            <div class="input-group">
                <label for="groupPicUrlInput" class="block text-gray-300 mb-1">URL da Foto do Grupo:</label>
                <input type="text" id="groupPicUrlInput" value="https://i.ibb.co/CKWjkPWy/si.jpg" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white" oninput="updateCanvas()">
            </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="bgUrlInput" class="block text-gray-300 mb-1">URL do Plano de Fundo (Opcional):</label>
                <input type="text" id="bgUrlInput" value="https://images.unsplash.com/photo-1550511520-21a1f599f65c?q=80&w=1500&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white" oninput="updateCanvas()">
            </div>
            <div>
                <label for="bgColorInput" class="block text-gray-300 mb-1">Cor S√≥lida de Fundo:</label>
                <div class="color-control">
                    <input type="color" id="bgColorInput" value="#0B1323" class="color-picker rounded bg-gray-700 border border-gray-600 cursor-pointer" oninput="syncColorInputs(this, 'bgColorHex'); updateCanvas()">
                    <input type="text" id="bgColorHex" value="#36393F" maxlength="7" class="color-input-hex p-1 rounded bg-gray-700 border border-gray-600 text-white" oninput="syncColorInputs(this, 'bgColorInput'); updateCanvas()">
                </div>
            </div>
        </div>
    </div>

    <div id="panel-text" class="panel">
        <div class="mt-4 border-t pt-4 border-gray-700">
            <h2 class="text-xl font-bold text-purple-400 mb-4">Ajustes de Texto e Cores</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="welcomeTextInput" class="block text-gray-300 mb-1">
                        Texto de Boas-Vindas:
                        <span class="text-xs text-blue-400 ml-2">X:<span id="welcomeXValue">450</span> Y:<span id="welcomeYValue">230</span></span>
                    </label>
                    <input type="text" id="welcomeTextInput" value="Bem Vindo(a)" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white" oninput="updateCanvas()">
                </div>
                <div class="input-group">
                    <label for="welcomeColorInput" class="block text-gray-300 mb-1">Cor do Texto de Boas-Vindas:</label>
                    <div class="color-control">
                        <input type="color" id="welcomeColorInput" value="#FFFFFF" class="color-picker rounded bg-gray-700 border border-gray-600 cursor-pointer" oninput="syncColorInputs(this, 'welcomeColorHex'); updateCanvas()">
                        <input type="text" id="welcomeColorHex" value="#FFFFFF" maxlength="7" class="color-input-hex p-1 rounded bg-gray-700 border border-gray-600 text-white" oninput="syncColorInputs(this, 'welcomeColorInput'); updateCanvas()">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                <div class="input-group">
                    <label for="groupNameColorInput" class="block text-gray-300 mb-1">Cor do Nome do Grupo:</label>
                    <div class="color-control">
                        <input type="color" id="groupNameColorInput" value="#FFD900" class="color-picker rounded bg-gray-700 border border-gray-600 cursor-pointer" oninput="syncColorInputs(this, 'groupNameColorHex'); updateCanvas()">
                        <input type="text" id="groupNameColorHex" value="#FFD900" maxlength="7" class="color-input-hex p-1 rounded bg-gray-700 border border-gray-600 text-white" oninput="syncColorInputs(this, 'groupNameColorInput'); updateCanvas()">
                    </div>
                </div>
                <div class="input-group">
                    <label for="idBoxColorInput" class="block text-gray-300 mb-1">
                        Cor do Box de ID:
                        <span class="text-xs text-blue-400 ml-2">X:<span id="idBoxXValue">450</span> Y:<span id="idBoxYValue">310</span></span>
                    </label>
                    <div class="color-control">
                        <input type="color" id="idBoxColorInput" value="#454545" class="color-picker rounded bg-gray-700 border border-gray-600 cursor-pointer" oninput="syncColorInputs(this, 'idBoxColorHex'); updateCanvas()">
                        <input type="text" id="idBoxColorHex" value="#000000" maxlength="7" class="color-input-hex p-1 rounded bg-gray-700 border border-gray-600 text-white" oninput="syncColorInputs(this, 'idBoxColorInput'); updateCanvas()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="panel-position" class="panel">
        <div class="mt-6 border-t pt-4 border-gray-700">
            <h2 class="text-xl font-bold text-blue-400 mb-4">Ajustes de Posi√ß√£o e Tamanho (Canvas 900x350px)</h2>

            <h3 class="text-lg font-semibold text-gray-300 mb-2 mt-4">Texto de Boas-Vindas (Tamanho)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-1">
                    <label for="welcomeFontSize" class="block text-gray-400 text-xs mb-1">Tamanho da Fonte: <span id="welcomeFontSizeValue">50</span>px</label>
                    <input type="range" id="welcomeFontSize" min="20" max="100" value="50" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
            </div>
            <hr class="mt-4 border-gray-700">
            <h3 class="text-lg font-semibold text-gray-300 mb-2 mt-4">Foto do Usu√°rio (Maior) - Arrast√°vel!</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="userRadius" class="block text-gray-400 text-xs mb-1">Raio (Tamanho): <span id="userRadiusValue">66</span>px</label>
                    <input type="range" id="userRadius" min="50" max="150" value="66" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
                <div>
                    <label for="userX" class="block text-gray-400 text-xs mb-1">Posi√ß√£o X: <span id="userXValue">437</span>px</label>
                    <input type="range" id="userX" min="50" max="850" value="437" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
                <div>
                    <label for="userY" class="block text-gray-400 text-xs mb-1">Posi√ß√£o Y: <span id="userYValue">110</span>px</label>
                    <input type="range" id="userY" min="50" max="300" value="110" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
            </div>

            <h3 class="text-lg font-semibold text-gray-300 mb-2 mt-6">Foto do Grupo (Menor) - Arrast√°vel!</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="groupRadius" class="block text-gray-400 text-xs mb-1">Raio (Tamanho): <span id="groupRadiusValue">35</span>px</label>
                    <input type="range" id="groupRadius" min="20" max="100" value="35" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
                <div>
                    <label for="groupX" class="block text-gray-400 text-xs mb-1">Posi√ß√£o X: <span id="groupXValue">655</span>px</label>
                    <input type="range" id="groupX" min="20" max="880" value="655" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
                <div>
                    <label for="groupY" class="block text-gray-400 text-xs mb-1">Posi√ß√£o Y: <span id="groupYValue">300</span>px</label>
                    <input type="range" id="groupY" min="20" max="330" value="300" class="w-full h-2 bg-gray-600 rounded-lg" oninput="updateCanvas()">
                </div>
            </div>

            <p class="text-sm text-gray-500 mt-4">Dica: Arraste o <strong>texto</strong>, a <strong>Caixa de ID</strong> ou as <strong>Fotos</strong> para mover os elementos. Em dispositivos touch, o canvas N√ÉO se move ao arrastar a √°rea vazia.</p>
        </div>
    </div>
    
    <div id="panel-summary" class="panel">
        <div class="mt-6 border-t pt-4 border-gray-700">
            <h2 class="text-xl font-bold text-green-400 mb-4">Resumo dos Ajustes (Canvas 900x350px)</h2>
            <div id="summary-content" class="text-sm text-gray-200 bg-gray-700 p-4 rounded-lg">
                Carregando resumo...
            </div>
            <p class="text-xs text-gray-500 mt-4">Os valores de cor e URL s√£o exibidos como foram configurados. As posi√ß√µes s√£o coordenadas (X, Y).</p>
        </div>
    </div>
    <div class="mt-4 flex gap-2">
        <button id="exportButton" onclick="exportConfigAsJson()" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Exportar Config (.json)</button>
        <button onclick="saveSelectedPanelToStorage()" class="w-1/2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Aba Atual</button>
    </div>
</div>

<canvas id="welcomeCanvas" width="900" height="350" class="shadow-2xl"></canvas>

<script>
    const FIXED_USER_NAME = 'Jo√£o_Victor#1234';
    const FIXED_GROUP_NAME = 'Grup lexi‚ú®';
    const USER_FALLBACK_COLOR = '#43B581';
    const GROUP_FALLBACK_COLOR = '#ED4245';
    const STORAGE_SELECTED_PANEL_KEY = 'welcome_canvas_selected_panel';

    const getWelcomeFont = () => {
        const size = document.getElementById('welcomeFontSize').value;
        return `900 ${size}px TTRuns, sans-serif`;
    };
    const DEFAULT_FONT = '28px Inter, sans-serif';

    let isDragging = false;
    let draggedElement = null;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    let canvasDragOffsetX = 0;
    let canvasDragOffsetY = 0;
    let isTouchDevice = (('ontouchstart' in window) || navigator.maxTouchPoints > 0);

    let state = {
        userX: 437, userY: 110,
        groupX: 655, groupY: 300,
        welcomeX: 450, welcomeY: 230,
        idBoxX: 450, idBoxY: 310
    };

    function initializeState() {
        state.userX = parseInt(document.getElementById('userX').value);
        state.userY = parseInt(document.getElementById('userY').value);
        state.groupX = parseInt(document.getElementById('groupX').value);
        state.groupY = parseInt(document.getElementById('groupY').value);
        state.welcomeX = 450;
        state.welcomeY = 230;
        state.idBoxX = 450;
        state.idBoxY = 310;
    }

    const loadImageAsync = (url) => {
        return new Promise((resolve) => {
            if (!url || url.trim() === '') return resolve(null);
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => resolve(img);
            img.onerror = () => { console.error(`[INFO] Falha ao carregar imagem: ${url}`); resolve(null); };
            img.src = url;
        });
    };

    const drawCircularImage = (ctx, x, y, radius, image, fallbackColor) => {
        ctx.save();
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2, true);
        ctx.fillStyle = fallbackColor;
        ctx.fill();
        ctx.closePath();
        ctx.restore();

        if (image) {
            ctx.save();
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2, true);
            ctx.closePath();
            ctx.clip();

            const imgWidth = image.width;
            const imgHeight = image.height;
            const targetSize = radius * 2;
            let sx, sy, sWidth, sHeight;
            const imgRatio = imgWidth / imgHeight;
            const targetRatio = 1;

            if (imgRatio > targetRatio) {
                sHeight = imgHeight;
                sWidth = imgHeight * targetRatio;
                sx = (imgWidth - sWidth) / 2;
                sy = 0;
            } else {
                sWidth = imgWidth;
                sHeight = imgWidth / targetRatio;
                sx = 0;
                sy = (imgHeight - sHeight) / 2;
            }

            const dx = x - radius;
            const dy = y - radius;
            const dWidth = targetSize;
            const dHeight = targetSize;

            ctx.drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);
            ctx.restore();
        }
    };

    function getElementBounds(ctx, config) {
        const WELCOME_TEXT = document.getElementById('welcomeTextInput').value;
        const ID_TEXT = FIXED_USER_NAME;

        const userAvatarBounds = { x: config.userX, y: config.userY, radius: config.userRadius };
        const groupAvatarBounds = { x: config.groupX, y: config.groupY, radius: config.groupRadius };

        const fontSize = document.getElementById('welcomeFontSize').value;
        ctx.font = getWelcomeFont();
        const welcomeMetrics = ctx.measureText(WELCOME_TEXT);
        const welcomeWidth = welcomeMetrics.width;
        const welcomeHeight = parseInt(fontSize);
        const welcomeBounds = {
            x: config.welcomeX - welcomeWidth / 2,
            y: config.welcomeY - welcomeHeight + 5,
            width: welcomeWidth,
            height: welcomeHeight * 1.1
        };

        ctx.font = DEFAULT_FONT;
        const idMetrics = ctx.measureText(ID_TEXT);
        const boxPaddingX = 20;
        const boxPaddingY = 10;
        const boxWidth = idMetrics.width + boxPaddingX * 2;
        const boxHeight = 28 + boxPaddingY * 2;
        const idBoxBounds = {
            x: config.idBoxX - boxWidth / 2,
            y: config.idBoxY - boxHeight / 2,
            width: boxWidth,
            height: boxHeight
        };

        return { welcome: welcomeBounds, idbox: idBoxBounds, userAvatar: userAvatarBounds, groupAvatar: groupAvatarBounds };
    }

    function hitTest(x, y, bounds) {
        return x >= bounds.x && x <= bounds.x + bounds.width &&
               y >= bounds.y && y <= bounds.y + bounds.height;
    }

    function hitTestCircle(x, y, circleBounds) {
        const dx = x - circleBounds.x;
        const dy = y - circleBounds.y;
        return (dx * dx + dy * dy) <= (circleBounds.radius * circleBounds.radius);
    }

    function syncColorInputs(sourceInput, targetId) {
        const targetInput = document.getElementById(targetId);
        let value = sourceInput.value.toUpperCase();

        if (targetId.includes('Hex')) {
            if (value.length === 7) {
                targetInput.value = value;
            }
        } else {
            if (!value.startsWith('#')) {
                value = '#' + value;
            }
            const hexPattern = /^#([0-9A-F]{3}){1,2}$/i;
            if (hexPattern.test(value)) {
                targetInput.value = value;
            }
        }
    }

    async function drawWelcomeCanvas(config) {
        const userPicUrl = document.getElementById('userPicUrlInput').value;
        const groupPicUrl = document.getElementById('groupPicUrlInput').value;

        const { bgUrl, bgColor, userRadius, groupRadius } = config;

        const userX = state.userX, userY = state.userY, groupX = state.groupX, groupY = state.groupY,
              welcomeX = state.welcomeX, welcomeY = state.welcomeY, idBoxX = state.idBoxX, idBoxY = state.idBoxY;

        const WELCOME_TEXT = document.getElementById('welcomeTextInput').value;
        const WELCOME_COLOR = document.getElementById('welcomeColorInput').value;
        const GROUP_NAME_COLOR = document.getElementById('groupNameColorInput').value;
        const ID_BOX_COLOR_BASE = document.getElementById('idBoxColorInput').value;
        const ID_BOX_COLOR = ID_BOX_COLOR_BASE + "E6";

        const WELCOME_FONT = getWelcomeFont();

        const canvas = document.getElementById('welcomeCanvas');
        const ctx = canvas.getContext('2d');
        const canvasWidth = canvas.width; const canvasHeight = canvas.height;

        try { await document.fonts.load(`900 100px TTRuns`); } catch (err) { console.warn("Fonte TTRuns falhou, fallback."); }

        const [bgImage, userPicData, groupPicData] = await Promise.all([
            loadImageAsync(bgUrl), loadImageAsync(userPicUrl), loadImageAsync(groupPicUrl)
        ]);

        // fundo
        if (bgImage) {
            const imgWidth = bgImage.width, imgHeight = bgImage.height;
            const canvasRatio = canvasWidth / canvasHeight, imgRatio = imgWidth / imgHeight;
            let drawW, drawH, offsetX, offsetY;
            if (imgRatio > canvasRatio) {
                drawH = canvasHeight;
                drawW = imgWidth * (canvasHeight / imgHeight);
                offsetX = (canvasWidth - drawW) / 2; offsetY = 0;
            } else {
                drawW = canvasWidth;
                drawH = imgHeight * (canvasWidth / imgWidth);
                offsetX = 0; offsetY = (canvasHeight - drawH) / 2;
            }
            ctx.drawImage(bgImage, offsetX, offsetY, drawW, drawH);
        } else {
            ctx.fillStyle = bgColor; ctx.fillRect(0,0,canvasWidth,canvasHeight);
        }

        ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
        ctx.beginPath();
        ctx.arc(canvasWidth * 0.1, canvasHeight * 0.9, 100, 0, Math.PI * 2);
        ctx.arc(canvasWidth * 0.9, canvasHeight * 0.1, 70, 0, Math.PI * 2);
        ctx.fill();

        drawCircularImage(ctx, userX, userY, userRadius, userPicData, USER_FALLBACK_COLOR);
        drawCircularImage(ctx, groupX, groupY, groupRadius, groupPicData, GROUP_FALLBACK_COLOR);

        const X_GROUP_NAME = groupX + groupRadius + 15;
        const Y_GROUP_NAME = groupY + 10;
        ctx.font = 'bold 30px Inter, sans-serif';
        ctx.textAlign = 'left';
        ctx.fillStyle = GROUP_NAME_COLOR;
        ctx.fillText(FIXED_GROUP_NAME, X_GROUP_NAME, Y_GROUP_NAME);

        ctx.font = WELCOME_FONT;
        ctx.textAlign = 'center';
        ctx.fillStyle = WELCOME_COLOR;
        ctx.fillText(WELCOME_TEXT, welcomeX, welcomeY);

        const ID_TEXT = FIXED_USER_NAME;
        ctx.font = DEFAULT_FONT;
        const textMetrics = ctx.measureText(ID_TEXT);
        const boxPaddingX = 20, boxPaddingY = 10;
        const boxWidth = textMetrics.width + boxPaddingX * 2;
        const boxHeight = 28 + boxPaddingY * 2;
        const boxX = idBoxX - boxWidth / 2, boxY = idBoxY - boxHeight / 2;
        const borderRadius = 8;

        ctx.fillStyle = ID_BOX_COLOR;
        ctx.beginPath();
        ctx.moveTo(boxX + borderRadius, boxY);
        ctx.lineTo(boxX + boxWidth - borderRadius, boxY);
        ctx.arcTo(boxX + boxWidth, boxY, boxX + boxWidth, boxY + borderRadius, borderRadius);
        ctx.lineTo(boxX + boxWidth, boxY + boxHeight - borderRadius);
        ctx.arcTo(boxX + boxWidth, boxY + boxHeight, boxX + boxWidth - borderRadius, boxY + boxHeight, borderRadius);
        ctx.lineTo(boxX + borderRadius, boxY + boxHeight);
        ctx.arcTo(boxX, boxY + boxHeight, boxX, boxY + boxHeight - borderRadius, borderRadius);
        ctx.lineTo(boxX, boxY + borderRadius);
        ctx.arcTo(boxX, boxY, boxX + borderRadius, boxY, borderRadius);
        ctx.fill();

        const textBaselineY = idBoxY + (28 / 2) - 2;
        ctx.fillStyle = '#FFFFFF';
        ctx.textAlign = 'center';
        ctx.font = DEFAULT_FONT;
        ctx.fillText(ID_TEXT, idBoxX, textBaselineY);
    }

    function getCurrentConfig() {
        return {
            bgUrl: document.getElementById('bgUrlInput').value,
            bgColor: document.getElementById('bgColorInput').value,
            welcomeText: document.getElementById('welcomeTextInput').value,
            welcomeColor: document.getElementById('welcomeColorInput').value,
            groupNameColor: document.getElementById('groupNameColorInput').value,
            idBoxColor: document.getElementById('idBoxColorInput').value,
            userRadius: parseInt(document.getElementById('userRadius').value),
            groupRadius: parseInt(document.getElementById('groupRadius').value),
            welcomeFontSize: parseInt(document.getElementById('welcomeFontSize').value),
            userX: Math.round(state.userX),
            userY: Math.round(state.userY),
            groupX: Math.round(state.groupX),
            groupY: Math.round(state.groupY),
            welcomeX: Math.round(state.welcomeX),
            welcomeY: Math.round(state.welcomeY),
            idBoxX: Math.round(state.idBoxX),
            idBoxY: Math.round(state.idBoxY)
        };
    }

    function updateCanvas() {
        state.userX = parseInt(document.getElementById('userX').value);
        state.userY = parseInt(document.getElementById('userY').value);
        state.groupX = parseInt(document.getElementById('groupX').value);
        state.groupY = parseInt(document.getElementById('groupY').value);

        syncColorInputs(document.getElementById('bgColorInput'), 'bgColorHex');
        syncColorInputs(document.getElementById('welcomeColorInput'), 'welcomeColorHex');
        syncColorInputs(document.getElementById('groupNameColorInput'), 'groupNameColorHex');
        syncColorInputs(document.getElementById('idBoxColorInput'), 'idBoxColorHex');

        document.getElementById('userRadiusValue').textContent = document.getElementById('userRadius').value;
        document.getElementById('userXValue').textContent = Math.round(state.userX);
        document.getElementById('userYValue').textContent = Math.round(state.userY);
        document.getElementById('groupRadiusValue').textContent = document.getElementById('groupRadius').value;
        document.getElementById('groupXValue').textContent = Math.round(state.groupX);
        document.getElementById('groupYValue').textContent = Math.round(state.groupY);
        document.getElementById('welcomeXValue').textContent = Math.round(state.welcomeX);
        document.getElementById('welcomeYValue').textContent = Math.round(state.welcomeY);
        document.getElementById('idBoxXValue').textContent = Math.round(state.idBoxX);
        document.getElementById('idBoxYValue').textContent = Math.round(state.idBoxY);

        document.getElementById('welcomeFontSizeValue').textContent = document.getElementById('welcomeFontSize').value;
        
        // Atualiza o resumo (se o painel estiver ativo)
        const activePanelId = document.getElementById('panelSelect').value;
        if (activePanelId === 'panel-summary') {
            updateSummaryPanel();
        }

        drawWelcomeCanvas(getCurrentConfig());
    }

    // --- FUN√á√ÉO PARA GERAR O NOVO PAINEL DE RESUMO ---
    function updateSummaryPanel() {
        const config = getCurrentConfig();
        const summaryDiv = document.getElementById('summary-content');
        
        let html = '';

        const summaryData = [
            { label: 'Cor de Fundo', value: config.bgColor, isColor: true },
            { label: 'URL de Fundo', value: config.bgUrl, isURL: true },
            { label: '--- Fotos ---', value: '' },
            { label: 'Foto do Usu√°rio (URL)', value: document.getElementById('userPicUrlInput').value, isURL: true },
            { label: 'Foto do Usu√°rio (Raio)', value: `${config.userRadius}px` },
            { label: 'Foto do Usu√°rio (Posi√ß√£o)', value: `(${config.userX}, ${config.userY})` },
            { label: 'Foto do Grupo (URL)', value: document.getElementById('groupPicUrlInput').value, isURL: true },
            { label: 'Foto do Grupo (Raio)', value: `${config.groupRadius}px` },
            { label: 'Foto do Grupo (Posi√ß√£o)', value: `(${config.groupX}, ${config.groupY})` },
            { label: '--- Texto ---', value: '' },
            { label: 'Texto de Boas-Vindas', value: config.welcomeText },
            { label: 'Cor do Texto B-V', value: config.welcomeColor, isColor: true },
            { label: 'Tam. do Texto B-V', value: `${config.welcomeFontSize}px` },
            { label: 'Pos. do Texto B-V', value: `(${config.welcomeX}, ${config.welcomeY})` },
            { label: 'Cor do Nome do Grupo', value: config.groupNameColor, isColor: true },
            { label: 'Cor do Box de ID', value: config.idBoxColor, isColor: true },
            { label: 'Posi√ß√£o do Box de ID', value: `(${config.idBoxX}, ${config.idBoxY})` }
        ];

        summaryData.forEach(item => {
            if (item.label.startsWith('---')) {
                html += `<div class="text-center font-bold text-lg mt-3 mb-1 text-yellow-300">${item.label.replace(/^-+\s*/, '').replace(/\s*-+$/, '')}</div>`;
            } else {
                let valueDisplay;
                if (item.isColor) {
                    valueDisplay = `<span style="background-color:${item.value}; border: 1px solid #4B5563;" class="inline-block w-4 h-4 rounded-full mr-2"></span>${item.value}`;
                } else if (item.isURL) {
                    // Trunca a URL para exibi√ß√£o
                    valueDisplay = item.value.length > 50 ? item.value.substring(0, 47) + '...' : item.value;
                } else {
                    valueDisplay = item.value;
                }
                
                html += `
                    <div class="summary-item">
                        <span class="text-gray-400">${item.label}:</span>
                        <span class="text-white font-medium break-all text-right">${valueDisplay}</span>
                    </div>
                `;
            }
        });

        summaryDiv.innerHTML = html;
    }
    // --- FIM DA FUN√á√ÉO DE RESUMO ---

    function onPanelChange() {
        const selectedId = document.getElementById('panelSelect').value;
        document.querySelectorAll('.panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.getElementById(selectedId).classList.add('active');
        
        // Se o painel de resumo for selecionado, atualize seu conte√∫do
        if (selectedId === 'panel-summary') {
            updateSummaryPanel();
        }

        // Tenta restaurar a √∫ltima aba salva
        localStorage.setItem(STORAGE_SELECTED_PANEL_KEY, selectedId);
    }
    
    function loadSelectedPanel() {
        const lastPanelId = localStorage.getItem(STORAGE_SELECTED_PANEL_KEY);
        if (lastPanelId && document.getElementById(lastPanelId)) {
            document.getElementById('panelSelect').value = lastPanelId;
            onPanelChange();
        } else {
            // Garante que o painel default (background) esteja ativo
            document.getElementById('panel-background').classList.add('active');
            document.getElementById('panelSelect').value = 'panel-background';
        }
    }

    function saveSelectedPanelToStorage() {
        const currentPanelId = document.getElementById('panelSelect').value;
        localStorage.setItem(STORAGE_SELECTED_PANEL_KEY, currentPanelId);
        alert(`Aba '${document.querySelector(`#panelSelect option[value='${currentPanelId}']`).textContent.trim()}' salva como prefer√™ncia inicial!`);
    }

    function updateRangeFromState(elementId, value) {
        const range = document.getElementById(elementId);
        if (range) range.value = Math.round(value);
    }

    function exportConfigAsJson() {
        const config = getCurrentConfig();
        const jsonString = JSON.stringify(config, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `canvas_config_${Date.now()}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function getCursorTarget(mouseX, mouseY, bounds) {
        if (hitTest(mouseX, mouseY, bounds.welcome) || hitTest(mouseX, mouseY, bounds.idbox) ||
            hitTestCircle(mouseX, mouseY, bounds.userAvatar) || hitTestCircle(mouseX, mouseY, bounds.groupAvatar)) {
            return 'element-draggable';
        }
        return 'canvas-draggable';
    }

    function handleInteractionStart(e, clientX, clientY, isTouch=false) {
        const canvas = document.getElementById('welcomeCanvas');
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();

        const mouseCanvasX = clientX - rect.left;
        const mouseCanvasY = clientY - rect.top;
        const bounds = getElementBounds(ctx, getCurrentConfig());

        if (hitTestCircle(mouseCanvasX, mouseCanvasY, bounds.userAvatar)) {
            draggedElement = 'userAvatar';
            dragOffsetX = mouseCanvasX - state.userX;
            dragOffsetY = mouseCanvasY - state.userY;
        } else if (hitTestCircle(mouseCanvasX, mouseCanvasY, bounds.groupAvatar)) {
            draggedElement = 'groupAvatar';
            dragOffsetX = mouseCanvasX - state.groupX;
            dragOffsetY = mouseCanvasY - state.groupY;
        } else if (hitTest(mouseCanvasX, mouseCanvasY, bounds.welcome)) {
            draggedElement = 'welcome';
            dragOffsetX = mouseCanvasX - state.welcomeX;
            dragOffsetY = mouseCanvasY - state.welcomeY;
        } else if (hitTest(mouseCanvasX, mouseCanvasY, bounds.idbox)) {
            draggedElement = 'idbox';
            dragOffsetX = mouseCanvasX - state.idBoxX;
            dragOffsetY = mouseCanvasY - state.idBoxY;
        } else {
            // -- AQUI: bloqueia mover o canvas em dispositivos touch (mobile)
            if (isTouchDevice && isTouch) {
                draggedElement = null; // impede movimento do canvas em touch
                return;
            }
            draggedElement = 'canvas';
            canvasDragOffsetX = clientX - rect.left;
            canvasDragOffsetY = clientY - rect.top;
        }

        if (draggedElement) {
            isDragging = true;
            canvas.classList.add('dragging');
        }
    }

    function handleInteractionMove(clientX, clientY) {
        const canvas = document.getElementById('welcomeCanvas');
        const rect = canvas.getBoundingClientRect();

        const mouseX = clientX - rect.left;
        const mouseY = clientY - rect.top;

        const currentConfig = getCurrentConfig();
        const bounds = getElementBounds(canvas.getContext('2d'), currentConfig);

        if (!isDragging) {
            const cursorTarget = getCursorTarget(mouseX, mouseY, bounds);
            if (cursorTarget === 'element-draggable') {
                canvas.classList.remove('canvas-draggable');
                canvas.classList.add('draggable');
            } else if (cursorTarget === 'canvas-draggable') {
                canvas.classList.remove('draggable');
                canvas.classList.add('canvas-draggable');
            } else {
                canvas.classList.remove('draggable');
                canvas.classList.remove('canvas-draggable');
            }
            return;
        }

        if (draggedElement === 'canvas') {
            if (!canvas.classList.contains('canvas-moved')) {
                canvas.classList.add('canvas-moved');
                const currentTop = rect.top + window.scrollY;
                const currentLeft = rect.left + window.scrollX;
                canvas.style.left = `${currentLeft}px`;
                canvas.style.top = `${currentTop}px`;
                canvas.style.margin = '0';
            }
            const newLeft = clientX - canvasDragOffsetX;
            const newTop = clientY - canvasDragOffsetY;
            canvas.style.left = `${newLeft}px`;
            canvas.style.top = `${newTop}px`;
        } else if (draggedElement) {
            let newX = mouseX - dragOffsetX;
            let newY = mouseY - dragOffsetY;

            let marginX = 50, marginY = 50;
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;

            if (draggedElement === 'userAvatar') {
                marginX = currentConfig.userRadius;
                marginY = currentConfig.userRadius;
                state.userX = Math.max(marginX, Math.min(canvasWidth - marginX, newX));
                state.userY = Math.max(marginY, Math.min(canvasHeight - marginY, newY));
                updateRangeFromState('userX', state.userX);
                updateRangeFromState('userY', state.userY);
            } else if (draggedElement === 'groupAvatar') {
                marginX = currentConfig.groupRadius;
                marginY = currentConfig.groupRadius;
                state.groupX = Math.max(marginX, Math.min(canvasWidth - marginX, newX));
                state.groupY = Math.max(marginY, Math.min(canvasHeight - marginY, newY));
                updateRangeFromState('groupX', state.groupX);
                updateRangeFromState('groupY', state.groupY);
            } else if (draggedElement === 'welcome') {
                // Margens para o texto de boas-vindas
                const welcomeWidth = bounds.welcome.width;
                const welcomeHeight = bounds.welcome.height;
                state.welcomeX = Math.max(welcomeWidth / 2, Math.min(canvasWidth - welcomeWidth / 2, newX));
                state.welcomeY = Math.max(welcomeHeight, Math.min(canvasHeight - 10, newY)); 
            } else if (draggedElement === 'idbox') {
                // Margens para a caixa de ID
                const boxWidth = bounds.idbox.width;
                const boxHeight = bounds.idbox.height;
                state.idBoxX = Math.max(boxWidth / 2, Math.min(canvasWidth - boxWidth / 2, newX));
                state.idBoxY = Math.max(boxHeight / 2 + 10, Math.min(canvasHeight - boxHeight / 2 - 10, newY));
            }

            updateCanvas();
        }
    }

    function handleInteractionEnd() {
        isDragging = false;
        draggedElement = null;
        const canvas = document.getElementById('welcomeCanvas');
        canvas.classList.remove('dragging');
        
        // Remove 'draggable' e 'canvas-draggable' para resetar o cursor padr√£o se n√£o estiver sobre um elemento
        canvas.classList.remove('draggable');
        canvas.classList.remove('canvas-draggable');
    }
    
    // Configura√ß√£o de Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        initializeState();
        updateCanvas();
        loadSelectedPanel(); 

        const canvas = document.getElementById('welcomeCanvas');

        // Mouse Events
        canvas.addEventListener('mousedown', (e) => handleInteractionStart(e, e.clientX, e.clientY, false));
        window.addEventListener('mousemove', (e) => handleInteractionMove(e.clientX, e.clientY));
        window.addEventListener('mouseup', handleInteractionEnd);

        // Touch Events
        canvas.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                e.preventDefault(); // Evita scroll ao tentar arrastar elemento
                handleInteractionStart(e, e.touches[0].clientX, e.touches[0].clientY, true);
            }
        }, { passive: false });
        
        window.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1 && isDragging) {
                e.preventDefault(); 
                handleInteractionMove(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: false });
        
        window.addEventListener('touchend', handleInteractionEnd);
        window.addEventListener('touchcancel', handleInteractionEnd);

        // Eventos de altera√ß√£o para todos os ranges/inputs que afetam o canvas
        document.querySelectorAll('input[type="range"], input[type="text"], input[type="color"]').forEach(input => {
            input.addEventListener('input', updateCanvas);
        });

    });

</script>

</body>
</html>